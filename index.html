<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 온라인 실험</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (CSS 스타일은 생략합니다. 기존 HTML 파일의 스타일을 사용합니다.) */
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span id="header-title">연구 참여 동의</span>
        <span class="close-btn" onclick="handleExit()">나가기 X</span>
    </header>

    <div class="content">
        <div id="step-consent"> 
            <h2>연구 참여 동의서</h2>
            <div style="background:#fafafa;  max-height: 220px; overflow-y: auto;  padding:15px; margin-bottom:20px; border:1px solid #eee;">
                본 연구는 상담 장면에서 내담자가 경험하는 인지 및 정서적 반응과 상담 만족도에 영향을 미치는 요인을 알아보기 위한 것입니다. 귀하는 온라인으로 제시되는 상담 장면(상담실 이미지와 상담과 관련된 대본)을 읽고, 해당 장면에 대한 인상과 예상되는 상담 경험에 대해 응답하게 됩니다.<br><br>
                이 설문은 전체 응답 기준으로 약 5~10분 정도 소요될 것으로 예상됩니다.<br><br>
                이 설문에는 동성 파트너와의 관계, 정서 경험, 상담에 대한 생각 등 민감할 수 있는 내용이 포함될 수 있습니다. 응답은 각 문항에 순서대로 답하는 방식으로 진행되며, 개별 문항을 건너뛰는 기능은 제공되지 않습니다. 다만 설문 참여 중단을 원하실 경우에는 언제든지 설문 창을 닫거나 “나가기” 버튼을 눌러 참여를 중단하실 수 있으며, 이로 인한 어떠한 불이익도 발생하지 않습니다.<br><br>
                수집된 모든 응답은 연구 목적을 위한 통계 분석에만 사용되며, IP 주소 등 개인을 식별할 수 있는 정보는 저장되지 않습니다. 연구 결과는 논문 및 학술 발표 등으로 보고되지만 개별 참가자를 식별할 수 있는 형태로 공개되지는 않습니다. 분석이 완료된 후에는 연구계획서에 명시된 기간 동안 암호화된 형태로 보관되었다가 안전한 방식으로 폐기됩니다.<br><br>
                설문 참여 과정에서 불편감이나 심리적 어려움을 느끼실 경우, 자살예방 상담전화(109), 생명의전화(1588-9191), 정신건강상담전화(1577-0199) 등의 공공 상담·지원 기관을 이용하실 수 있습니다.
            </div>
            <label>
                <input type="checkbox" id="consent-chk"> 본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.
            </label>
        </div>

        <div id="step-screener" class="hidden"> 
            <p>연구 참여 기준 확인을 위해 정보를 입력해 주세요.</p>
            
            <div class="form-group">
                <label class="form-label">1. 귀하의 연령은?</label>
                <select class="form-control" id="age">
                    <option value="">선택하세요</option>
                    <option value="under18">만 18세 미만</option>
                    <option value="18-29">만 18세~29세</option>
                    <option value="30-39">만 30세~39세</option>
                    <option value="over40">만 40세 이상</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">2. 현재 거주하고 있는 곳은 어디입니까?</label>
                <select class="form-control" id="residence">
                    <option value="">선택하세요</option>
                    <option value="korea">대한민국</option>
                    <option value="abroad">대한민국 외 지역</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">3. 당신의 성적지향은 무엇입니까?</label>
                <select class="form-control" id="orientation">
                    <option value="">선택하세요</option>
                    <option value="homo">동성애자(레즈비언, 게이)</option>
                    <option value="bi">양성애자(바이섹슈얼)</option>
                    <option value="hetero">이성애자</option>
                    <option value="other">그 외</option>
                    <option value="none">모름</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-1. 귀하의 출생 시 법적/생물학적 성별은 무엇입니까?</label>
                <select class="form-control" id="birth_sex" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Male)</option>
                    <option value="female">여성 (Female)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-2. 귀하가 현재 인식하는 성별 정체성은 무엇입니까?</label>
                <select class="form-control" id="current_gender" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Male)</option>
                    <option value="female">여성 (Female)</option>
                    <option value="nonbinary">논바이너리 (Non-binary)</option>
                    <option value="other">기타 (그 외 다른 정체성)</option>
                </select>
            </div>
            <input type="hidden" id="final_identity_value" value="">
        </div>

        <div id="step-instruction" class="hidden">
            <h2>실험 진행 안내</h2>
            <div class="info-box">
                <p style="margin-top:0; font-weight:bold;">[잠시 후 실험 장면이 제시됩니다]</p>
                <ul style="padding-left: 20px; margin-bottom:0;">
                    <li>귀하는 <strong>상담실 이미지</strong>와 상담자와 나의 <strong>대화 내용</strong>을 보게 됩니다.</li>
                    <li><strong>각 화면은 최소 3초가 지나야 다음으로 넘어갈 수 있습니다.</strong></li>
                    <li>화면을 주의 깊게 본 후 이후 물음에 답해 주세요.</li>
                    <li>준비가 되셨다면 아래 <strong>'다음'</strong> 버튼을 눌러 시작해 주세요.</li>
                </ul>
            </div>
        </div>

        <div id="step-vignette" class="hidden">
            </div>

        <div id="step-des" class="hidden">
            </div>

        <div id="step-csq" class="hidden">
            </div>
        
           <div id="step-check" class="hidden">
            </div>

        <div id="step-debrief" class="hidden">
            </div>
    </div>

    <div class="bottom-bar">
        <button id="prev-btn" class="footer-btn" onclick="handlePrev()">이전</button>
        <button id="main-btn" class="footer-btn" onclick="handleNext()">다음 ></button>
    </div>
</div>

<script>
    // ▼▼▼▼▼▼ [중요] 구글 스크립트 URL ▼▼▼▼▼▼
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5u3GaICzyfh5Ybxj15oWppBfxWRb0g7UC5eMY8FxzGRUqkAest-yQgxeg2PW2goOf/exec";
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    const RESEARCHER_CONTACT = "연구자 김윤서 (이메일: pape5344@daegu.ac.kr)";

    /* --- 1. 실험 변수 및 상태 관리 --- */
    const conditions = ['cross', 'buddha', 'none'];
    let state = {
        step: 'consent',
        condition: '',
        vignetteIndex: 0,
        data: {},
        startTime: 0,
        userIP: 'unknown',
        visitedVignettes: new Set(),
        timer: null
    };

    const imgFiles = {
        'cross': 'cross.png',
        'buddha': 'buddha.png',
        'none': 'none.png',
        'waiting': 'waiting.png'
    };

    // [비네트 데이터] - (25개 문항 - 0~24 인덱스)
    const vignettes = [
        // --- 비네트 1 (Index 0 ~ 6): 대기실 상황 ---
        `<span class="desc">당신은 최근 동성 애인과의 관계로 힘든 시기를 보냈습니다.</span>`, // 0
        `<span class="desc">사소한 말다툼에도 이별과 재결합이 끊임없이 반복되었습니다.<br>당신은 수면 부족과 우울, 외로움에 시달리고 있습니다.</span>`, // 1
        `<span class="desc">잠을 제대로 못자고 아침에 지각하는 경우가 잦아지며 일상 생활에서도 어려움이 이어졌습니다.</span>`, // 2
        `<span class="desc">결국 전문가의 도움을 받기로 결심하고 집 근처 상담센터를 찾았습니다.<br>대기실 벽에 걸린 상담자의 이력과 자격증을 보니 마음이 놓입니다.<br>당신은 직원의 안내에 따라 상담 경험과 방문 목적을 묻는 간단한 질문지를 작성했습니다.</span>`, // 3
        `<span class="inner-thought">(여기라면 내 이야기를 편견 없이 들어주지 않을까?)</span>`, // 4
        `<span class="desc">당신은 기대와 긴장이 뒤섞인 마음으로 상담을 기다립니다.</span>`, // 5
        `<span class="desc">이제 직원의 안내에 따라 상담실 문을 열고 들어갑니다.</span>`, // 6

        // --- 비네트 2 (Index 7 ~ 24): 상담실 입장 (조건 이미지) ---
        `<span class="desc">[당신은 상담실을 한 번 둘러봅니다.]</span>`, // 7
        `<span class="dialogue"><span class="speaker">상담자:</span> 날이 추운데 오는데 힘들지는 않았어요?</span>`, // 8
        `<span class="dialogue"><span class="speaker">나:</span> 네, 따뜻하게 입었더니 괜찮았어요.</span>`, // 9
        `<span class="inner-thought">(무슨 말을 해야 하지? 상담은 처음이라 긴장되네…)</span>`, // 10
        `<span class="dialogue"><span class="speaker">상담자:</span> 상담은 처음 받아본다고 하셨죠?</span>`, // 11
        `<span class="dialogue"><span class="speaker">나:</span> 네… 어떤 걸 말해야 할지 잘 모르겠어요.</span>`, // 12
        `<span class="dialogue"><span class="speaker">상담자:</span> 처음 오시는 분들이 대부분 그렇게 말씀하세요. 준비되신 만큼만 천천히 이야기해 주셔도 괜찮아요.<br><span class="desc">[사전에 작성한 질문지를 살핀다]</span><br>최근에 잠을 잘 못 주무셨다고요?</span>`, // 13
        `<span class="dialogue"><span class="speaker">나:</span> 네.. 요즘 잠을 잘 못 자요. 밤에 자주 뒤척이다가 새벽에 겨우 잠들고, 몇 주 째 아침마다 지각도 하고… 정신이 너무 없어요.</span>`, // 14
        `<span class="dialogue"><span class="speaker">상담자:</span> 잠을 못 잘 정도로 신경 쓰이는 일이 있었어요?</span>`, // 15
        `<span class="dialogue"><span class="speaker">나:</span> (잠시 침묵) …네, 그냥 전반적으로 요즘 많이 힘들어서요. 우울하고 외로워서… 어디 이야기할 데도 없고요.<br>음, 이런 이야기도 해도 되는지 모르겠는데...</span>`, // 16
        `<span class="inner-thought">(애인 때문이라고 말할까? 내가 <b>[동성/양성]애자</b>인 걸 알면 이 사람이 어떻게 반응할지 모르겠어… 친구라고 말해야 하나?)</span>`, // 17
        `<span class="dialogue"><span class="speaker">상담자:</span> 떠오르는 게 있다면 편한 것부터 말씀해 주셔도 돼요.</span>`, // 18
        `<span class="dialogue"><span class="speaker">나:</span> …가장 친한 사람과의 관계가 계속 꼬여서요. 예전에 크게 다투고 연락을 끊었는데, 최근에 연락이 와서 다시 받아줬거든요… 근데 또 반복되더라고요. 달라진 건 없고… 끊어내질 못하고 너무 지쳐요.</span>`, // 19
        `<span class="dialogue"><span class="speaker">상담자:</span> 친구인가요? 소중하게 생각하는 사람인데 인연이 끊어졌다 이어졌다를 반복하니까 마음이 많이 소모되셨겠어요.</span>`, // 20
        `<span class="inner-thought">[상담자의 부드러운 눈빛을 보며 조금 안도하지만, 당신은 여전히 <b>‘애인’</b>이라는 단어를 꺼낼지 고민합니다.]</span>`, // 21
        `<span class="dialogue"><span class="speaker">나:</span> ..네.</span>`, // 22 
        `<span class="inner-thought">[당신은 망설이다가 결국 말을 멈추었습니다.<br>상담자는 당신의 말을 기다려주다가 입을 엽니다.]</span>`, // 23
        `<span class="dialogue"><span class="speaker">상담자:</span> ..오늘은 시간이 여기까지네요. 이야기 해주셔서 감사해요. 다음에 오실 때는 왜 그 사람을 끊어내지 못하는지에 대해 생각해 오시면 함께 더 깊이 이야기해 볼 수 있을 거예요. 무리하지 말고 천천히 같이 해봐요.​</span>`, // 24
    ];


    const desQuestions = [
        "1. 이 상담자에게 당신의 사적인 이야기를 하는 것은 위험할까요?",
        "2. 당신이 지금까지 아무에게도 말한 적이 없는 매우 사적인 일을 이 상담자에게 말한다면 불안하게 느껴질까요?",
        "3. 당신에게 슬프거나 괴로운 일이 생긴다면, 문제와 관련된 당신의 개인정보를 이 상담자에게 드러내는 것이 도움이 될까요?",
        "4. 당신의 숨겨둔 감정을 이 상담자에게 드러내는 것이 위험할까요?",
        "5. 당신이 이 상담자를 찾아가 속 이야기를 한다면 주변 사람들이 어떻게 생각할지 걱정되나요?",
        "6. 이 상담자에게 자신의 속마음을 말하는 것은 도움이 될까요?",
        "7. 만약 당신이 슬픔이나 불안 같은 감정을 드러낸다면 기분이 더 나아질까요?",
        "8. 만약 당신이 고민 중인 문제를 이 상담자에게 터놓는다면 실질적인 도움을 받을 것 같나요?"
    ];

    const csqQuestions = [
        "1. 귀하가 받은 상담의 질은 어떠했습니까?",
        "2. 원했던 종류의 상담을 받았습니까?",
        "3. 이번 상담이 귀하의 필요를 어느 정도 충족시켰습니까?",
        "4. 친구가 비슷한 도움이 필요하다면, 이 상담을 추천하시겠습니까?",
        "5. 상담을 통해 받은 도움의 양에 얼마나 만족하십니까?",
        "6. 이 상담이 문제를 더 효과적으로 다루는 데 도움이 되었습니까?",
        "7. 전반적으로, 귀하가 받은 상담에 대해 얼마나 만족하십니까?",
        "8. 다시 상담을 받는다면, 이 상담 기관을 다시 이용하시겠습니까?"
    ];

    /* --- [기능] IP 가져오기 및 중복 참여 확인 --- */
    window.onload = function() {
        // 1. IP 주소 가져오기
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                state.userIP = data.ip;
                console.log("User IP:", state.userIP);
            })
            .catch(error => {
                console.log("IP Fetch Error: " + error);
                // IP 수집 실패 시에도 추적 가능한 값으로 설정
                state.userIP = "FETCH_FAILED_" + Date.now(); 
            });
            
        // 2. 로컬 스토리지 확인 (동일 기기/브라우저 중복 참여 방지)
        if (localStorage.getItem('participation_completed') === 'true') {
            const app = document.querySelector('.app-container');
            app.innerHTML = `
                <div style="padding:40px; text-align:center;">
                    <h2 style="color:#e74c3c;">참여 완료</h2>
                    <p>이미 본 실험에 참여하셨습니다.<br>더 이상 설문을 진행할 수 없습니다.<br><br>창을 닫아주세요.</p>
                </div>
            `;
            document.body.backgroundColor = "#eee";
            return;
        }
    };


    /* --- [기능] 성별 정체성 판별 --- */
    function checkGenderIdentity() {
        const birth = document.getElementById("birth_sex").value;
        const current = document.getElementById("current_gender").value;
        const hiddenInput = document.getElementById("final_identity_value");

        if (birth === "" || current === "") {
            if(hiddenInput) hiddenInput.value = "";
            return;
        }

        let isCis = ((birth === "male" && current === "male") || (birth === "female" && current === "female"));
        if(hiddenInput) hiddenInput.value = isCis ? "cis" : "trans";
    }

    /* --- [기능] 비네트 텍스트 치환 --- */
    const wordMap = { "homo": "동성", "bi": "양성" };
    function getProcessedText(index) {
        let text = vignettes[index];
        const savedType = localStorage.getItem('userType');
        const targetWord = wordMap[savedType] || "동성";
        return text.replace(/\[동성\/양성\]/g, targetWord);
    }

    /* --- [기능] 스크리닝 탈락 처리 및 자동 종료 --- */
    function handleScreenFail() {
        alert("죄송합니다.\n본 연구의 참여 대상 기준에 부합하지 않아 참여하실 수 없습니다.\n(확인 버튼을 누르면 종료됩니다.)");

        const failData = {
            id: Date.now(),
            condition: "SCREEN_OUT",
            demographics: state.data.demographics,
            // vignetteTime: [] <-- GAS에서 제거했으므로 클라이언트에서도 제거해야 함
            check_answer: "N/A",
            des: [],
            csq: [],
            phone: "",
            ip: state.userIP
        };

        // NOTE: GAS에서도 IP 유효성 검사를 하므로, 'unknown' IP를 가진 탈락자는 기록되지 않을 수 있습니다.
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(failData)
        }).catch(error => console.log("Fail Log Error:", error));

        const app = document.querySelector('.app-container');
        app.innerHTML = `
            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; text-align:center;">
                <h2 style="color:#e74c3c;">참여 불가 안내</h2>
                <p style="color:#555; font-size:14px; line-height:1.6;">
                    죄송합니다.<br>
                    귀하는 본 연구의 참여 기준에 부합하지 않아<br>
                    더 이상 설문을 진행하실 수 없습니다.<br><br>
                    참여해 주셔서 감사합니다.
                </p>
            </div>
        `;
        document.body.style.backgroundColor = "#eee";
    }

    /* --- 로직 제어 함수 --- */
    function hideAllSteps() {
        document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
    }

    // (handlePrev 함수는 기존 로직을 유지합니다.)
    function handlePrev() {
        const btnPrev = document.getElementById('prev-btn');
        const btnNext = document.getElementById('main-btn');
        btnNext.innerText = "다음 >";
        btnNext.disabled = false;

        if (state.step === 'vignette' && state.vignetteIndex > 0) {
            state.vignetteIndex--;
            renderVignette();
        } else if (state.step === 'des') {
            state.step = 'vignette'; 
            state.vignetteIndex = vignettes.length - 1; 
            renderVignette();
            document.getElementById('header-title').innerText = "상황 제시";
        } else if (state.step === 'csq') {
            state.step = 'des';
            hideAllSteps();
            document.getElementById('step-des').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (1/2)";
            btnPrev.style.display = 'block';
        }
        else if (state.step === 'check') { 
            state.step = 'csq';
            hideAllSteps();
            document.getElementById('step-csq').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (2/2)";
            btnPrev.style.display = 'block';
        }
        else if (state.step === 'debrief') { 
            state.step = 'check';
            hideAllSteps();
            document.getElementById('step-check').classList.remove('hidden');
            document.getElementById('header-title').innerText = "확인 문항";
            btnPrev.style.display = 'block';
            btnNext.innerText = "다음 >";
        }
        
        window.scrollTo(0,0);
    }


    function handleNext() {
        const btn = document.getElementById('main-btn');

        // 1. 연구 동의
        if (state.step === 'consent') {
            if (!document.getElementById('consent-chk').checked) {
                alert('연구 참여에 동의하셔야 진행할 수 있습니다.');
                return;
            }
            state.step = 'screener';
            hideAllSteps();
            document.getElementById('step-screener').classList.remove('hidden');
            document.getElementById('header-title').innerText = "기본 정보 입력";
            window.scrollTo(0,0);
        }

        // 2. 스크리너 단계
        else if (state.step === 'screener') {
            const age = document.getElementById('age').value;
            const residence = document.getElementById('residence').value;
            const orientation = document.getElementById('orientation').value;
            const birthSex = document.getElementById('birth_sex').value;
            const currentGender = document.getElementById('current_gender').value;
            const calculatedIdentity = document.getElementById('final_identity_value').value;

            if (!age || !residence || !orientation || !birthSex || !currentGender) {
                alert('모든 항목을 선택해 주세요.');
                return;
            }

            // *** IP 수집 완료 확인 로직 ***
            if (state.userIP === 'unknown') {
                alert('IP 주소를 가져오는 중입니다. 잠시 후 다시 시도해 주세요.');
                setTimeout(() => handleNext(), 1000); 
                return;
            }

            // 입력 정보 임시 저장
            state.data.demographics = {
                age, residence, orientation, birthSex, currentGender,
                identity: calculatedIdentity
            };
            
            // NOTE: GAS에서 vignetteTime을 받지 않기로 했으므로, 클라이언트에서도 이 데이터는 필요 없습니다.
            // state.data.vignetteTime = []; // <-- 이 줄은 제거합니다.
            

            // 탈락 조건 체크
            if (
                age === 'under18' ||
                residence === 'abroad' ||
                (orientation !== 'homo' && orientation !== 'bi') ||
                calculatedIdentity !== 'cis'
            ) {
                handleScreenFail();
                return;
            }

            // 통과 시
            state.condition = conditions[Math.floor(Math.random() * conditions.length)];
            state.data.condition = state.condition;
            // state.data.vignetteTime = []; // 이 줄을 제거했습니다.
            localStorage.setItem('userType', orientation);

            console.log("Assigned Condition: " + state.condition);

            // Instruction 단계로 이동
            state.step = 'instruction';
            hideAllSteps();
            document.getElementById('step-instruction').classList.remove('hidden');
            document.getElementById('header-title').innerText = "실험 안내";
            window.scrollTo(0,0);
        }

        // 3. 실험 안내 -> 비네트
        else if (state.step === 'instruction') {
            state.step = 'vignette';
            state.vignetteIndex = 0;
            state.visitedVignettes.clear();
            hideAllSteps();
            document.getElementById('step-vignette').classList.remove('hidden');
            document.getElementById('header-title').innerText = "상황 제시";
            
            // NOTE: vignetteTime을 사용하지 않으므로, 이 부분을 주석 처리하거나 제거해야 합니다.
            // state.data.vignetteTime = []; // 재시작 시점에만 필요
            
            renderVignette();
        }

        // 4. 비네트 진행
        else if (state.step === 'vignette') {
            const spentTime = Date.now() - state.startTime;
            // state.data.vignetteTime.push(spentTime); // <-- 이 로직을 제거합니다.
            
            state.visitedVignettes.add(state.vignetteIndex);

            state.vignetteIndex++;
            if (state.vignetteIndex < vignettes.length) { 
                renderVignette();
            } else {
                // 비네트 끝 -> 설문 1 (DES)
                document.getElementById('des-ref-img').src = imgFiles[state.condition];
                renderScales('des', desQuestions, 5, 'step-des');
                state.step = 'des';
                hideAllSteps();
                document.getElementById('step-des').classList.remove('hidden');
                document.getElementById('header-title').innerText = "설문 조사 (1/2)";
                document.getElementById('prev-btn').style.display = 'block';
            }
            window.scrollTo(0,0);
        }

        // 5. 설문 (DES)
        else if (state.step === 'des') {
            if (!validateScale(desQuestions.length, 'des')) return;
            collectScaleData('des', desQuestions.length);
            
            // 설문 1 끝 -> 설문 2 (CSQ)
            document.getElementById('csq-ref-img').src = imgFiles[state.condition];
            renderScales('csq', csqQuestions, 7, 'step-csq');
            state.step = 'csq';
            hideAllSteps();
            document.getElementById('step-csq').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (2/2)";
            window.scrollTo(0,0);
        }
        
        // 6. 설문 (CSQ) -> 조작 점검 (CHECK) 단계로 이동
        else if (state.step === 'csq') {
            if (!validateScale(csqQuestions.length, 'csq')) return;
            collectScaleData('csq', csqQuestions.length);

            state.step = 'check'; 
            hideAllSteps();
            document.getElementById('step-check').classList.remove('hidden');
            document.getElementById('header-title').innerText = "확인 문항";
            window.scrollTo(0,0);
        }
        
        // 7. 조작 점검 (CHECK) -> 디브리핑 (DEBRIEF) 단계로 이동
        else if (state.step === 'check') {
            const selectedOption = document.querySelector('input[name="check_opt"]:checked');
            if (!selectedOption) {
                alert('보기 중 하나를 선택해 주세요.');
                return;
            }

            let finalAnswer = selectedOption.value;
            if (finalAnswer === 'etc') {
                const etcText = document.getElementById('check-etc-text').value.trim();
                if (etcText.length < 1) {
                    alert('기타 내용을 입력해 주세요.');
                    return;
                }
                finalAnswer = '기타: ' + etcText;
            }
            state.data.check_answer = finalAnswer;

            state.step = 'debrief'; 
            hideAllSteps();
            document.getElementById('step-debrief').classList.remove('hidden');
            document.getElementById('researcher-info').innerText = RESEARCHER_CONTACT;

            document.getElementById('header-title').innerText = "종료 및 안내";
            btn.innerText = "제출 및 종료";
            window.scrollTo(0,0);
        }
        
        // 8. 최종 종료
        else if (state.step === 'debrief') {
            sendDataToGoogle();
        }
    }

    /* 비네트 렌더링 & 3초 카운트다운 타이머 */
    function renderVignette() {
        const idx = state.vignetteIndex;
        const btnNext = document.getElementById('main-btn');
        const btnPrev = document.getElementById('prev-btn');
        const imgContainer = document.getElementById('image-container-vig');
        const imgEl = document.getElementById('stimulus-img');
        const totalVignettes = vignettes.length;

        // 텍스트 렌더링
        document.getElementById('vignette-text').innerHTML = getProcessedText(idx);
        document.getElementById('page-counter').innerText = `${idx + 1} / ${totalVignettes}`;

        // 이미지 표시 로직
        imgContainer.style.display = 'block';
        if (idx < 7) {
            imgEl.src = imgFiles['waiting'];
        } else {
            imgEl.src = imgFiles[state.condition];
        }

        // 이전 버튼 관리
        if (idx === 0) {
            btnPrev.style.display = 'none';
        } else {
            btnPrev.style.display = 'block';
            btnPrev.disabled = false;
        }

        // 타이머 및 카운트다운 로직
        if (state.timer) clearInterval(state.timer);

        if (state.visitedVignettes.has(idx)) {
            // 이미 방문: 즉시 활성화
            btnNext.disabled = false;
            btnNext.innerText = "다음 >";
            state.startTime = Date.now();
        } else {
            // 처음 방문: 3초 카운트다운
            let timeLeft = 3;
            
            btnNext.disabled = true;
            btnNext.innerText = `다음 (${timeLeft})`;
            
            state.startTime = Date.now();

            state.timer = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    btnNext.innerText = `다음 (${timeLeft})`;
                } else {
                    clearInterval(state.timer);
                    btnNext.disabled = false;
                    btnNext.innerText = "다음 >";
                    state.visitedVignettes.add(idx);
                }
            }, 1000);
        }
    }

    /* 구글 전송 및 중복 확인 */
    function sendDataToGoogle() {
        const btn = document.getElementById('main-btn');
        const phoneInput = document.getElementById('reward-phone').value.trim();
        
        btn.disabled = true;
        btn.innerText = "결과 보내는 중...";

        const finalData = {
            id: Date.now(),
            condition: state.data.condition,
            demographics: state.data.demographics,
            // NOTE: GAS에서 이 항목을 받지 않도록 삭제했습니다.
            // vignetteTime: state.data.vignetteTime, 
            check_answer: state.data.check_answer,
            des: state.data.des,
            csq: state.data.csq,
            phone: phoneInput,
            ip: state.userIP
        };
        
        // Fetch API를 사용하여 POST 요청 (no-cors 모드 유지)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(finalData)
        })
        .then(() => {
            // GAS가 중복을 거절했더라도 클라이언트에서는 응답을 읽을 수 없어 성공으로 간주됨.
            handleSubmissionSuccess(); 
        })
        .catch(error => {
            console.error("Error during submission:", error);
            alert("⚠️ 데이터 전송 중 오류가 발생했습니다.\n네트워크 상태를 확인하거나 연구자에게 문의해 주세요.");
            btn.disabled = false;
            btn.innerText = "제출 및 종료";
        });
        
        // 데이터 전송 성공 처리 함수
        function handleSubmissionSuccess() {
            // 로컬 스토리지에 참여 완료 플래그 설정 (동일 기기 중복 방지)
            localStorage.setItem('participation_completed', 'true');
            
            alert("결과가 성공적으로 제출되었습니다.\n참여해 주셔서 감사합니다.");
            
            // 최종 종료 화면 표시
            document.querySelector('.app-container').innerHTML =
                "<div style='padding:40px; text-align:center;'><h2>실험 종료</h2><p>수고하셨습니다.<br>창을 닫으셔도 됩니다.</p></div>";
        }

    }

    /* 유틸리티 함수 */
    function renderScales(prefix, questions, maxScale, containerId) {
        const container = document.getElementById(containerId === 'step-des' ? 'des-container' : 'csq-container');
        container.innerHTML = "";
        questions.forEach((q, index) => {
            let html = `<div class="scale-group"><span class="scale-question">${q}</span><div class="scale-options">`;
            for(let i=1; i<=maxScale; i++) {
                html += `<label class="scale-option"><input type="radio" name="${prefix}_q${index}" value="${i}">${i}</label>`;
            }
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    function validateScale(count, prefix) {
        for(let i=0; i<count; i++) {
            if (!document.querySelector(`input[name="${prefix}_q${i}"]:checked`)) {
                alert(`${i+1}번 문항에 응답해 주세요.`);
                // 해당 위치로 스크롤 이동
                const qEl = document.getElementsByName(`${prefix}_q${i}`)[0];
                qEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }
        }
        return true;
    }

    function collectScaleData(prefix, count) {
        state.data[prefix] = [];
        for(let i=0; i<count; i++) {
            state.data[prefix].push(document.querySelector(`input[name="${prefix}_q${i}"]:checked`).value);
        }
    }

    function toggleEtc(isShow) {
        const etcInput = document.getElementById('check-etc-text');
        if (isShow) {
            etcInput.classList.remove('hidden');
            etcInput.focus();
        } else {
            etcInput.classList.add('hidden');
            etcInput.value = "";
        }
    }

    function handleExit() {
        if (confirm("정말로 실험을 중단하고 나가시겠습니까?\n지금 나가시면 결과가 전송되지 않습니다.")) {
            window.open('','_self').close();
            window.close();
            document.querySelector('.app-container').innerHTML =
                "<div style='padding:40px; text-align:center;'><h2>종료</h2><p>창을 닫아주세요.</p></div>";
        }
    }
</script>
</body>
</html>

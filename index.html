<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 온라인 실험</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 디자인 시스템 (모바일 친화적 UI) --- */
        :root {
            --primary-color: #5bc2e7;
            --primary-dark: #2db6e0;
            --header-bg: #343a40;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #333333;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh; /* 화면 전체 높이 고정 */
            overflow: hidden; /* 바깥 스크롤 방지 */
            color: var(--text-main);
        }

        .app-container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column; /* 세로 정렬 필수 */
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
        }

        /* 헤더 */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            flex-shrink: 0; /* 헤더 크기 고정 */
            z-index: 200;
        }
        .close-btn { cursor: pointer; font-size: 14px; color: #ccc; }

        /* 컨텐츠 영역 */
        .content {
            flex: 1; /* 남은 공간을 꽉 채움 */
            padding: 0 24px 24px 24px; /* 상단 패딩 제거 (sticky를 위해) */
            overflow-y: auto; /* 내용 길면 스크롤 */
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* [핵심] 상단 고정(플로팅) 이미지 박스 스타일 */
        .sticky-top-box {
            position: -webkit-sticky; /* 사파리 호환 */
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--card-bg); /* 배경색 필수 */
            padding-top: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sticky-top-box img {
            max-height: 25vh; /* 화면 높이의 25%까지만 차지 */
            max-width: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        h2 { font-size: 20px; margin-bottom: 20px; color: #222; margin-top: 20px; }
        p, label, li { font-size: 15px; line-height: 1.6; color: #444; }

        .hidden { display: none !important; }

        /* 입력 폼 스타일 */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 15px; box-sizing: border-box;
        }
        
        /* 하단 고정 버튼 영역 */
        .bottom-bar {
            width: 100%;
            background: white;
            border-top: 1px solid #eee;
            flex-shrink: 0; /* 크기 줄어들지 않음 */
            padding: 0;
            z-index: 200;
        }

        .footer-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 18px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background 0.3s;
        }
        .footer-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .footer-btn:hover:not(:disabled) { background-color: var(--primary-dark); }

        /* --- 타이머 바 스타일 --- */
        .timer-container {
            position: relative;
            width: 100%;
            height: 36px;
            background-color: #f0f0f0;
            border-radius: 20px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: #ffeef5;
            border-right: 2px solid #ffb6d0;
        }

        .timer-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            color: #d63384; 
            font-size: 13px; 
            font-weight: bold;
        }

        .vignette-box {
            background: #fafafa; padding: 20px; border-radius: 8px; 
            border-left: 4px solid var(--primary-color);
            min-height: 120px;
        }

        /* 척도 질문 스타일 */
        .scale-group { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .scale-question { font-weight: 500; margin-bottom: 10px; display: block; }
        .scale-options { display: flex; justify-content: space-between; margin-top: 10px; }
        .scale-option { text-align: center; font-size: 12px; cursor: pointer; flex: 1; }
        .scale-option input { display: block; margin: 0 auto 5px; transform: scale(1.2); }
        
        /* 스크리너 경고 */
        .error-msg { color: red; font-size: 13px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span id="header-title">연구 참여 동의</span>
        <span class="close-btn" onclick="handleExit()">나가기 X</span>
    </header>

    <div class="content">
        <div id="step-consent"> 
            <h2>연구 참여 동의서</h2>
            <div style="background:#fafafa; padding:15px; font-size:13px; margin-bottom:20px; border:1px solid #eee;">
                [연구 목적 및 절차 안내]<br><br>
                본 연구는 상담 장면에서 내담자가 경험하는 인지 및 정서적 반응과 상담 만족도에 영향을 미치는 요인을 알아보기 위한 것입니다. 귀하는 온라인으로 제시되는 상담 장면(상담실 환경과 상담자의 반응 묘사)을 읽고, 해당 장면에 대한 인상과 예상되는 상담 경험에 대해 응답하게 됩니다.<br><br>
                이 설문에는 동성 파트너와의 관계, 정서 경험, 상담에 대한 생각 등 민감할 수 있는 내용이 포함될 수 있습니다. 응답은 각 문항에 순서대로 답하는 방식으로 진행되며, 개별 문항을 건너뛰는 기능은 제공되지 않습니다. 다만 설문 참여 중단을 원하실 경우에는 언제든지 설문 창을 닫거나 “그만두기” 버튼을 눌러 참여를 중단하실 수 있으며, 이로 인한 어떠한 불이익도 발생하지 않습니다. 수집된 모든 응답은 연구 목적을 위한 통계 분석에만 사용되며, IP 주소 등 개인을 식별할 수 있는 정보는 저장되지 않습니다. 연구 결과는 논문 및 학술 발표 등으로 보고되지만, 개별 참가자를 식별할 수 있는 형태로 공개되지는 않습니다. 분석이 완료된 후에는 연구계획서에 명시된 기간 동안 암호화된 형태로 보관되었다가 안전한 방식으로 폐기됩니다.
            </div>
            <label>
                <input type="checkbox" id="consent-chk"> 본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.
            </label>
        </div>

        <div id="step-screener" class="hidden"> 
            <p>연구 참여 기준 확인을 위해 정보를 입력해 주세요.</p>
            
            <div class="form-group">
                <label class="form-label">1. 귀하의 연령은?</label>
                <select class="form-control" id="age">
                    <option value="">선택하세요</option>
                    <option value="under18">만 18세 미만</option>
                    <option value="18-29">만 18세~29세</option>
                    <option value="30-39">만 30세~39세</option>
                    <option value="over40">만 40세 이상</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">2. 현재 거주하고 있는 곳은 어디입니까?</label>
                <select class="form-control" id="residence">
                    <option value="">선택하세요</option>
                    <option value="korea">대한민국</option>
                    <option value="abroad">대한민국 외 지역</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">3. 당신의 성적지향은 무엇입니까?</label>
                <select class="form-control" id="orientation">
                    <option value="">선택하세요</option>
                    <option value="homo">동성애자(레즈비언, 게이)</option>
                    <option value="bi">양성애자(바이섹슈얼)</option>
                    <option value="hetero">이성애자</option>
                    <option value="other">그 외</option>
                    <option value="none">모름</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-1. 귀하의 출생 시 법적/생물학적 성별은 무엇입니까?</label>
                <select class="form-control" id="birth_sex" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Male)</option>
                    <option value="female">여성 (Female)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-2. 귀하가 현재 인식하는 성별 정체성은 무엇입니까?</label>
                <select class="form-control" id="current_gender" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Man)</option>
                    <option value="female">여성 (Woman)</option>
                    <option value="nonbinary">논바이너리 (Non-binary)</option>
                    <option value="other">기타 (그 외 다른 정체성)</option>
                </select>
            </div>

            <input type="hidden" id="final_identity_value" value="">

            <p class="error-msg" id="screen-fail-msg">죄송합니다. 본 연구의 참여 대상 기준에 부합하지 않아 참여하실 수 없습니다.</p>
        </div>

        <div id="step-vignette" class="hidden">
            <div class="sticky-top-box" id="vignette-sticky-header">
                <div class="timer-container" id="timer-msg">
                    <div class="timer-bar" id="timer-progress"></div>
                    <div class="timer-text">⏳ 15초 뒤에 다음 버튼이 활성화됩니다.</div>
                </div>
                <div id="image-container-vig">
                    <img id="stimulus-img" src="" alt="상담실 이미지">
                </div>
            </div>

            <div class="vignette-box">
                <p id="vignette-text" style="margin:0; font-size:16px; line-height:1.7;">
                    </p>
            </div>
            <p style="text-align:center; color:#999; font-size:13px; margin-top:10px;" id="page-counter">1 / 5</p>
        </div>

        <div id="step-check" class="hidden">
            <h2>기억 회상</h2>
            <p>방금 보신 상담실 장면을 떠올려 주세요.<br>벽이나 가구 주변에서 <strong>특히 기억에 남는 물건이나 표시</strong>가 있다면 선택해 주세요.</p>
            
            <div class="form-group" style="text-align: left; background: #fafafa; padding: 20px; border-radius: 8px;">
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="cross" onclick="toggleEtc(false)"> 십자가
                </label>
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="buddha" onclick="toggleEtc(false)"> 불상 (부처상)
                </label>
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="none" onclick="toggleEtc(false)"> 없음
                </label>
                <label class="radio-label" style="display:block; margin-bottom:0; cursor:pointer;">
                    <input type="radio" name="check_opt" value="etc" onclick="toggleEtc(true)"> 기타 (직접 입력)
                </label>
            </div>

            <input type="text" id="check-etc-text" class="form-control hidden" placeholder="기억나는 물건을 직접 적어주세요." style="margin-top: 10px;">
        </div>

        <div id="step-des" class="hidden">
            <div class="sticky-top-box">
                <img id="des-ref-img" src="" alt="참고 이미지">
                <p style="margin:5px 0 0 0; font-size:12px; color:#666;">※ 위 상담실과 상담자를 떠올리며 응답해 주세요.</p>
            </div>
            
            <h2>설문 1/2</h2>
            <p>다음 문항들은 방금 보신 상담실 장면에서, 그 상담자에게 당신의 고민을 털어놓는 것에 대해 어떻게 예상하고 계신지를 묻는 질문입니다. (1: 전혀 그렇지 않다 ~ 5: 매우 그렇다)</p>
            <div id="des-container"></div>
        </div>

        <div id="step-csq" class="hidden">
            <div class="sticky-top-box">
                <img id="csq-ref-img" src="" alt="참고 이미지">
                <p style="margin:5px 0 0 0; font-size:12px; color:#666;">※ 위 상담실과 상담자를 떠올리며 응답해 주세요.</p>
            </div>

            <h2>설문 2/2</h2>
            <p>다음 문항들은 방금 경험하신 상담 장면 전체에 대해, 당신이 얼마나 만족하거나 도움이 될 것 같다고 느끼는지를 묻는 질문입니다. (1: 전혀 아니다 ~ 7: 매우 그렇다)</p>
            <div id="csq-container"></div>
        </div>

        <div id="step-debrief" class="hidden">
            <h2>참여해 주셔서 감사합니다.</h2>
            
            <div style="text-align: left; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin-top:0;"><strong>[연구 목적 안내]</strong><br>
                본 연구는 상담 장면에서 <strong>상담실에 배치된 종교적 상징이 성소수자 내담자가 느끼는 안전감, 자기개방 기대, 상담 만족도에 어떤 영향을 미치는지</strong>를 알아보기 위한 실험이었습니다.
                </p>

                <p>
                설문에 사용된 상담실 이미지는 연구 목적을 위해 생성형 인공지능(AI) 도구를 사용하여 제작한 이미지입니다. 상담자의 모습과 상담실의 전반적 분위기는 동일하게 유지한 채, 종교 상징(십자가, 불상, 없음)만 다르게 표현하도록 설계하였습니다.
                </p>

                <p>
                연구 과정에서 종교 상징의 효과를 미리 알리면 응답이 왜곡될 수 있어 동의서와 설문 시작 단계에서는 구체적인 연구 목적을 모두 밝히지 못한 점을 양해 부탁드립니다. 응답 내용은 모두 익명으로 처리되며, 개별 참가자를 식별할 수 없는 형태로만 연구에 사용됩니다. 이 설명을 들은 후 자신의 자료 사용을 원치 않는 경우, 아래 연구자 연락처로 알려주시면 즉시 자료를 삭제하겠습니다.
                </p>
                
                <p><strong>[문의 및 도움처]</strong><br>
                본 연구와 관련하여 문의사항이 있거나 연구 참여로 인한 불편감이 있는 경우 아래의 연구자에게 연락해 주십시오.
                </p>
                <p id="researcher-info" style="color:#0056b3; font-weight:bold;"></p>
                
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">
                
                <p style="font-size: 13px; color: #666; margin-bottom:5px;">
                추가적인 심리적 지원이 필요하신 경우 아래 기관을 이용하실 수 있습니다.
                </p>
                <ul style="font-size:13px; margin-top:0; color:#555;">
                <li>청소년 성소수자 위기지원센터 띵동: 02-924-1224</li>
                <li>한국생명의전화: 1588-9191</li>
                <li>정신건강상담전화: 1577-0199</li>
                </ul>
            </div>

            <div style="text-align: left; background: #fff3cd; padding: 20px; border-radius: 8px; border: 1px solid #ffeeba;">
                <p style="margin-top:0; font-weight:bold; color:#856404;">☕ 참여 보상 (선택 사항)</p>
                <p style="font-size:13px; color:#856404;">
                실험에 참여해 주신 분들께 소정의 커피 쿠폰을 드립니다.<br>
                원하시는 분은 핸드폰 번호를 입력해 주세요.<br>
                <span style="font-size:12px; color:#997404;">
                    * 수집된 번호는 보상 제공 용도로만 사용되며, 지급 후 즉시 파기됩니다.<br>
                    * 번호를 입력하지 않으셔도 실험은 정상적으로 종료되며 어떠한 불이익도 없습니다.
                </span>
                </p>
                <input type="tel" id="reward-phone" class="form-control" placeholder="01012345678 (숫자만 입력)">
            </div>

            <p style="margin-top:20px; font-size:13px; color:#666; text-align: center;">
                아래 버튼을 누르면 응답이 최종 제출되며 설문이 종료됩니다.
            </p>
        </div>
    </div>

    <div class="bottom-bar">
        <button id="main-btn" class="footer-btn" onclick="handleNext()">다음 ></button>
    </div>
</div>

<script>
    // ▼▼▼▼▼▼ [중요] 구글 스크립트 URL ▼▼▼▼▼▼
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5u3GaICzyfh5Ybxj15oWppBfxWRb0g7UC5eMY8FxzGRUqkAest-yQgxeg2PW2goOf/exec"; 
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    const RESEARCHER_CONTACT = "연구자 김윤서 (이메일: pape5344@daegu.ac.kr)";

    /* --- 1. 실험 변수 및 상태 관리 --- */
    const conditions = ['cross', 'buddha', 'none']; 
    let state = {
        step: 'consent', 
        condition: '', 
        vignetteIndex: 0, 
        data: {}, 
        startTime: 0,
        userIP: 'unknown' 
    };

    const imgFiles = {
        'cross': 'cross.png',
        'buddha': 'buddha.png',
        'none': 'none.png'
    };

    const vignettes = [
        "당신은 최근 동성 애인과의 관계에서 반복되는 갈등으로 인해 한계에 다다랐음을 느낍니다. 사소한 말다툼부터 이별과 재결합이 끊임없이 반복되면서, 이제는 지치고 외롭다는 감정조차 버겁게 느껴집니다.<br><br>결국 전문가의 도움을 받기로 결심하고 상담센터를 찾았습니다. 대기실 벽에 걸린 상담자의 이력과 자격증을 보니 꽤 전문적인 사람인 것 같아 마음이 조금 놓입니다.<br>‘여기라면 내 이야기를 들어줄 수 있지 않을까?’<br>당신은 기대와 긴장이 뒤섞인 마음으로 상담실 입장을 기다립니다.",
        "이름을 부르는 소리에 안내를 받아 상담실로 들어갑니다. 상담자와 마주 보고 앉자, 자연스럽게 상담실 내부의 풍경과 분위기가 눈에 들어옵니다.<br><br>낯선 공간이 주는 긴장감에 당신은 마른침을 삼킵니다.<br>\"상담은 처음이라... 어디서부터 말해야 할지 모르겠네요.\"<br><br>상담자는 온화한 미소로 당신을 맞이합니다.<br>\"처음 오시는 자리라 낯설고 긴장되는 게 당연합니다. 이곳은 안전한 공간이니, 준비되신 만큼만 천천히 이야기해 주셔도 괜찮습니다.\"",
        "당신은 애인과 수없이 헤어지고 다시 만나는 과정을 반복하며 지쳐있습니다. 이 이야기를 솔직하게 털어놓으려던 찰나, 당신은 상담실의 분위기를 살피며 잠시 멈칫합니다.<br>혹시라도 나의 정체성을 알게 되었을 때 상담자가 편견을 가질까 봐 걱정이 앞섭니다.<br><br>결국 당신은 안전을 위해 ‘동성 애인’과의 관계를 ‘친구’로 바꿔서 이야기하기로 결심합니다.<br>\"그냥... 가장 친한 친구랑 문제가 좀 있어서요. 그 친구랑 절교했다가 다시 연락했다가... 이게 계속 반복되니까 너무 지쳐요.\"<br><br>당신은 ‘애인’이라는 단어를 삼키고 ‘친구’라고 말하며 조심스럽게 상담자의 반응을 살핍니다.",
        "상담자는 당신의 눈을 편안하게 맞추며, 당신이 느꼈을 감정의 무게를 있는 그대로 받아줍니다.<br>\"정말 소중한 친구분인가 보네요. 가깝고 깊은 관계일수록, 갈등이 반복될 때 겪게 되는 마음의 소모는 이루 말할 수 없이 크죠.\"<br><br>상담자는 침착하고 신뢰감 있는 목소리로 말을 이어갑니다.<br>\"서로를 아끼는 마음과 힘든 상황이 충돌하면서 많이 혼란스러우셨을 것 같습니다. 오늘 이 시간만큼은, 그 관계에서 겪으셨던 마음들을 안전하게 털어놓으셔도 괜찮습니다.\"<br><br>상담자의 태도는 흠잡을 데 없이 훌륭하며, 당신의 고통을 진지하게 존중해주고 있습니다.",
        "상담자의 따뜻하고 전문적인 반응에 당신은 상담자가 꽤 괜찮은 사람이라는 인상을 받습니다. 내 이야기를 진지하게 들어주려는 태도가 느껴집니다.<br><br>하지만 문득 마음 한구석에 물음표가 떠오릅니다.<br>‘선생님은 정말 좋으신 분 같지만... 내가 [동성/양성]애자라는 걸 아셔도 이렇게 받아주실까?’<br><br>당신은 상담자의 친절한 태도를 보며 복잡한 마음이 듭니다."
    ];

    const desQuestions = [
        "1. 당신의 개인적인 정보를 이 상담자에게 노출하는 것은 어려운 일일까요?",
        "2. 당신이 지금까지 아무에게도 말한 적이 없는 매우 사적인 일을 이 상담자에게 말한다면 불안하게 느껴질까요?",
        "3. 당신에게 슬프거나 괴로운 일이 생긴다면, 문제와 관련된 당신의 개인정보를 이 상담자에게 드러내는 것이 도움이 될까요?",
        "4. 당신의 숨겨둔 감정을 이 상담자에게 드러내는 것이 위험할까요?",
        "5. 이 상담자에게 부정적인 감정을 드러낼 때, 상담자가 무슨 생각을 할지 걱정되나요?",
        "6. 이 상담자에게 자신의 속마음을 말하는 것은 도움이 될까요?",
        "7. 만약 당신이 슬픔이나 불안 같은 감정을 이 상담자에게 노출한다면 기분이 나아질까요?",
        "8. 만약 당신이 고민 중인 정서적 문제를 이 상담자에게 드러낸다면 유용한 반응을 얻을 수 있을까요?"
    ];

    const csqQuestions = [
        "1. 이 상담은 훌륭한 상담일 것이다.",
        "2. 나는 이번 상담을 통해 내가 원하는 도움을 받을 수 있을 것이다.",
        "3. 이번 상담을 통해 나의 기대는 충족될 것이다.",
        "4. 내 친구가 나와 비슷한 고민을 한다면 이 상담을 추천할 것 같다.",
        "5. 나는 상담을 만족스럽게 끝낼 것이다.",
        "6. 이번 상담은 내가 고민을 해결하고 극복하는 데 도움을 줄 것이다.",
        "7. 이번 상담은 전반적으로 나에게 만족스러울 것이다.",
        "8. 내가 상담을 받아야 할 필요가 있다면 이 상담자를 만나고 싶다."
    ];

    /* --- [초기화] IP 가져오기 및 중복 참여 확인 --- */
    window.onload = function() {
        // [테스트 중] 중복 체크 기능 비활성화 (주석 처리)
        // if (localStorage.getItem('participation_completed')) {
        //     document.querySelector('.app-container').innerHTML = `
        //         <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; text-align:center;">
        //             <h2 style="color:#e74c3c;">참여 제한</h2>
        //             <p style="color:#555;">이미 본 연구에 참여하셨습니다.<br>중복 참여는 불가능합니다.</p>
        //         </div>
        //     `;
        //     return; 
        // }

        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                state.userIP = data.ip;
                console.log("User IP:", state.userIP);
            })
            .catch(error => console.log("IP Fetch Error:", error));
    };

    /* --- [기능] 성별 정체성 판별 함수 (수정됨: 텍스트 출력 제거) --- */
    function checkGenderIdentity() {
        const birth = document.getElementById("birth_sex").value;
        const current = document.getElementById("current_gender").value;
        const hiddenInput = document.getElementById("final_identity_value");

        if (birth === "" || current === "") {
            if(hiddenInput) hiddenInput.value = "";
            return;
        }

        let isCis = false;
        if ((birth === "male" && current === "male") || 
            (birth === "female" && current === "female")) {
            isCis = true;
        } else {
            isCis = false;
        }

        // 화면 표시는 하지 않고, hidden input 값만 업데이트
        if(hiddenInput) {
            hiddenInput.value = isCis ? "cis" : "trans";
        }
    }

    /* --- [기능] 비네트 텍스트 치환 함수 --- */
    const wordMap = {
        "homo": "동성",
        "bi": "양성"
    };

    function getProcessedText(index) {
        let text = vignettes[index];
        const savedType = localStorage.getItem('userType'); 
        const targetWord = wordMap[savedType] || "동성"; 
        return text.replaceAll("[동성/양성]", targetWord);
    }

    /* --- 2. 로직 제어 함수 --- */
    function hideAllSteps() {
        document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
    }

    function handleNext() {
        const btn = document.getElementById('main-btn');

        // 1. 연구 동의
        if (state.step === 'consent') {
            if (!document.getElementById('consent-chk').checked) {
                alert('연구 참여에 동의하셔야 진행할 수 있습니다.');
                return;
            }
            state.step = 'screener';
            hideAllSteps();
            document.getElementById('step-screener').classList.remove('hidden');
            document.getElementById('header-title').innerText = "기본 정보 입력";
            window.scrollTo(0,0);
        }

        // 2. 스크리너 단계
        else if (state.step === 'screener') {
            const age = document.getElementById('age').value;
            const residence = document.getElementById('residence').value;
            const orientation = document.getElementById('orientation').value;
            const birthSex = document.getElementById('birth_sex').value;
            const currentGender = document.getElementById('current_gender').value;
            const calculatedIdentity = document.getElementById('final_identity_value').value; 

            if (!age || !residence || !orientation || !birthSex || !currentGender) {
                alert('모든 항목을 선택해 주세요.');
                return;
            }

            if (
                age === 'under18' ||                           
                residence === 'abroad' ||                      
                (orientation !== 'homo' && orientation !== 'bi') || 
                calculatedIdentity !== 'cis'                   
            ) {
                document.getElementById('screen-fail-msg').style.display = 'block';
                document.getElementById('screen-fail-msg').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            state.data.demographics = { 
                age, residence, orientation, birthSex, currentGender,
                identity: calculatedIdentity
            };
            
            state.condition = conditions[Math.floor(Math.random() * conditions.length)];
            state.data.condition = state.condition;
            state.data.vignetteTime = [];
            localStorage.setItem('userType', orientation); 

            console.log("Assigned Condition: " + state.condition);

            state.step = 'vignette';
            state.vignetteIndex = 0;
            hideAllSteps();
            document.getElementById('step-vignette').classList.remove('hidden');
            document.getElementById('header-title').innerText = "상황 제시";
            
            renderVignette();
        }

        // 3. 비네트 진행
        else if (state.step === 'vignette') {
            const spentTime = Date.now() - state.startTime;
            state.data.vignetteTime.push(spentTime);

            state.vignetteIndex++;
            if (state.vignetteIndex < vignettes.length) {
                renderVignette();
            } else {
                state.step = 'check';
                hideAllSteps();
                document.getElementById('step-check').classList.remove('hidden');
                document.getElementById('header-title').innerText = "확인 문항";
            }
            window.scrollTo(0,0);
        }

        // 4. 조작 점검 제출
        else if (state.step === 'check') {
            const selectedOption = document.querySelector('input[name="check_opt"]:checked');
            if (!selectedOption) {
                alert('보기 중 하나를 선택해 주세요.');
                return;
            }

            let finalAnswer = selectedOption.value;
            if (finalAnswer === 'etc') {
                const etcText = document.getElementById('check-etc-text').value.trim();
                if (etcText.length < 1) {
                    alert('기타 내용을 입력해 주세요.');
                    return;
                }
                finalAnswer = '기타: ' + etcText;
            }
            state.data.check_answer = finalAnswer;

            // [sticky] 이미지 설정
            document.getElementById('des-ref-img').src = imgFiles[state.condition];

            renderScales('des', desQuestions, 5, 'step-des');
            state.step = 'des';
            hideAllSteps();
            document.getElementById('step-des').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (1/2)";
            window.scrollTo(0,0);
        }

        // 5. 설문 제출 (DES, CSQ)
        else if (state.step === 'des') {
            if (!validateScale(desQuestions.length, 'des')) return;
            collectScaleData('des', desQuestions.length);
            
            // [sticky] 이미지 설정
            document.getElementById('csq-ref-img').src = imgFiles[state.condition];

            renderScales('csq', csqQuestions, 7, 'step-csq');
            state.step = 'csq';
            hideAllSteps();
            document.getElementById('step-csq').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (2/2)";
            window.scrollTo(0,0);
        }
        else if (state.step === 'csq') {
            if (!validateScale(csqQuestions.length, 'csq')) return;
            collectScaleData('csq', csqQuestions.length);

            state.step = 'debrief';
            hideAllSteps();
            document.getElementById('step-debrief').classList.remove('hidden');
            document.getElementById('researcher-info').innerText = RESEARCHER_CONTACT; 

            document.getElementById('header-title').innerText = "종료 및 안내";
            btn.innerText = "제출 및 종료";
            window.scrollTo(0,0);
        }

        // 7. 최종 종료
        else if (state.step === 'debrief') {
            sendDataToGoogle();
        }
    }

    /* 비네트 렌더링 & 시각적 타이머 */
    function renderVignette() {
        const idx = state.vignetteIndex;
        const btn = document.getElementById('main-btn');
        const imgContainer = document.getElementById('image-container-vig'); 
        const imgEl = document.getElementById('stimulus-img');
        const timerContainer = document.getElementById('timer-msg');
        const timerProgress = document.getElementById('timer-progress');

        document.getElementById('vignette-text').innerHTML = getProcessedText(idx);
        document.getElementById('page-counter').innerText = `${idx + 1} / 5`;

        // 1번 비네트는 이미지 없음, 2번부터 이미지 표시
        if (idx === 0) {
            imgContainer.style.display = 'none';
        } else {
            imgContainer.style.display = 'block';
            imgEl.src = imgFiles[state.condition];
        }

        btn.disabled = true;
        btn.innerText = "지문을 읽어주세요. (5초)"; // [요청] 5초로 텍스트 변경
        timerContainer.style.visibility = 'visible';
        
        timerProgress.style.transition = 'none'; 
        timerProgress.style.width = '100%'; 
        void timerProgress.offsetWidth; 
        timerProgress.style.transition = 'width 5s linear'; // [요청] 5초 애니메이션
        timerProgress.style.width = '0%';

        state.startTime = Date.now();
        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = "다음 >";
            timerContainer.style.visibility = 'hidden'; 
        }, 5000); // [요청] 5000ms (5초) 대기
    }

    /* 구글 전송 */
    function sendDataToGoogle() {
        const btn = document.getElementById('main-btn');
        const phoneInput = document.getElementById('reward-phone').value.trim();
        
        btn.disabled = true;
        btn.innerText = "데이터 저장 중...";

        const finalData = {
            id: Date.now(),
            condition: state.data.condition,
            demographics: state.data.demographics,
            vignetteTime: state.data.vignetteTime,
            check_answer: state.data.check_answer,
            des: state.data.des,
            csq: state.data.csq,
            phone: phoneInput,
            ip: state.userIP 
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(finalData)
        })
        .then(() => {
            localStorage.setItem('participation_completed', 'true');
            alert("데이터가 성공적으로 제출되었습니다.\n참여해 주셔서 감사합니다.");
            document.querySelector('.app-container').innerHTML = 
                "<div style='padding:40px; text-align:center;'><h2>실험 종료</h2><p>수고하셨습니다.<br>창을 닫으셔도 됩니다.</p></div>";
        })
        .catch(error => {
            console.error("Error:", error);
            alert("데이터 전송 중 오류가 발생했습니다.\n연구자에게 문의해 주세요.");
        });
    }

    /* 유틸리티: 척도 렌더링, 유효성 검사, 데이터 수집 */
    function renderScales(prefix, questions, maxScale, containerId) {
        const container = document.getElementById(containerId === 'step-des' ? 'des-container' : 'csq-container');
        container.innerHTML = "";
        questions.forEach((q, index) => {
            let html = `<div class="scale-group"><span class="scale-question">${q}</span><div class="scale-options">`;
            for(let i=1; i<=maxScale; i++) {
                html += `<label class="scale-option"><input type="radio" name="${prefix}_q${index}" value="${i}">${i}</label>`;
            }
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }
    function validateScale(count, prefix) {
        for(let i=0; i<count; i++) {
            if (!document.querySelector(`input[name="${prefix}_q${i}"]:checked`)) {
                alert(`${i+1}번 문항에 응답해 주세요.`);
                return false;
            }
        }
        return true;
    }
    function collectScaleData(prefix, count) {
        state.data[prefix] = [];
        for(let i=0; i<count; i++) {
            state.data[prefix].push(document.querySelector(`input[name="${prefix}_q${i}"]:checked`).value);
        }
    }
    function toggleEtc(isShow) {
        const etcInput = document.getElementById('check-etc-text');
        if (isShow) {
            etcInput.classList.remove('hidden');
            etcInput.focus();
        } else {
            etcInput.classList.add('hidden');
            etcInput.value = "";
        }
    }
        
    /* --- [기능] 나가기 버튼 처리 함수 --- */
    function handleExit() {
        if (confirm("정말로 실험을 중단하고 나가시겠습니까?\n지금 나가시면 데이터가 저장되지 않습니다.")) {
            window.open('','_self').close(); 
            window.close();

            const app = document.querySelector('.app-container');
            app.innerHTML = `
                <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; text-align:center;">
                    <h2 style="color:#555;">실험이 종료되었습니다.</h2>
                    <p style="color:#777; font-size:14px;">
                        창을 닫거나 브라우저를 종료해 주세요.<br>
                        참여해 주셔서 감사합니다.
                    </p>
                </div>
            `;
            document.body.style.backgroundColor = "#eee";
        }
    }
</script>

</body>
</html>

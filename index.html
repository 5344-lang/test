<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 가상 상담 이미지 설문조사</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 디자인 시스템 (모바일 친화적 UI) --- */
        :root {
            --primary-color: #5bc2e7;
            --primary-dark: #2db6e0;
            --header-bg: #343a40;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #333333;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--text-main);
        }

        .app-container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
        }

        /* 헤더 */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .close-btn { cursor: pointer; font-size: 14px; color: #ccc; }

        /* 컨텐츠 영역 */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        h2 { font-size: 20px; margin-bottom: 20px; color: #222; margin-top: 0; }
        p, label, li { font-size: 15px; line-height: 1.6; color: #444; }

        .hidden { display: none !important; }

        /* 입력 폼 스타일 */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 15px; box-sizing: border-box;
        }
        
        /* 하단 고정 버튼 영역 */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #eee;
        }

        .footer-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 18px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background 0.3s;
        }
        .footer-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .footer-btn:hover:not(:disabled) { background-color: var(--primary-dark); }

        /* --- 타이머 바 스타일 --- */
        .timer-container {
            position: relative;
            width: 100%;
            height: 36px;
            background-color: #f0f0f0;
            border-radius: 20px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: #ffeef5;
            border-right: 2px solid #ffb6d0;
        }

        .timer-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            color: #d63384; 
            font-size: 13px; 
            font-weight: bold;
        }
        /* -------------------------------- */

        #image-container {
            width: 100%;
            height: 250px;
            background-color: #eee;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        #image-container img { width: 100%; height: 100%; object-fit: cover; }

        .vignette-box {
            background: #fafafa; padding: 20px; border-radius: 8px; 
            border-left: 4px solid var(--primary-color);
            min-height: 120px;
        }

        /* 척도 질문 스타일 */
        .scale-group { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .scale-question { font-weight: 500; margin-bottom: 10px; display: block; }
        .scale-options { display: flex; justify-content: space-between; margin-top: 10px; }
        .scale-option { text-align: center; font-size: 12px; cursor: pointer; flex: 1; }
        .scale-option input { display: block; margin: 0 auto 5px; transform: scale(1.2); }
        
        /* 스크리너 경고 */
        .error-msg { color: red; font-size: 13px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span id="header-title">연구 참여 동의</span>
        <span class="close-btn" onclick="alert('창을 닫으면 실험이 종료됩니다.')">나가기 X</span>
    </header>

    <div class="content">
        
        <div id="step-consent"> <h2>연구 참여 동의서</h2>
            <div style="height: 200px; overflow-y: scroll; background:#fafafa; padding:15px; font-size:13px; margin-bottom:20px; border:1px solid #eee;">
                [연구 목적 및 절차 안내]<br><br>
                본 연구는 상담 장면에서 내담자가 경험하는 인지 및 정서적 반응과 상담 만족도에 영향을 미치는 요인을 알아보기 위한 것입니다. 귀하는 온라인으로 제시되는 상담 장면(상담실 환경과 상담자의 반응 묘사)을 읽고, 해당 장면에 대한 인상과 예상되는 상담 경험에 대해 응답하게 됩니다.<br><br>
               이 설문에는 동성 파트너와의 관계, 정서 경험, 상담에 대한 생각 등 민감할 수 있는 내용이 포함될 수 있습니다. 응답은 각 문항에 순서대로 답하는 방식으로 진행되며, 개별 문항을 건너뛰는 기능은 제공되지 않습니다. 다만 설문 참여 중단을 원하실 경우에는 언제든지 설문 창을 닫거나 “그만두기” 버튼을 눌러 참여를 중단하실 수 있으며, 이로 인한 어떠한 불이익도 발생하지 않습니다. 수집된 모든 응답은 연구 목적을 위한 통계 분석에만 사용되며, IP 주소 등 개인을 식별할 수 있는 정보는 저장되지 않습니다. 연구 결과는 논문 및 학술 발표 등으로 보고되지만, 개별 참가자를 식별할 수 있는 형태로 공개되지는 않습니다. 분석이 완료된 후에는 연구계획서에 명시된 기간 동안 암호화된 형태로 보관되었다가 안전한 방식으로 폐기됩니다.
            </div>
            <label>
                <input type="checkbox" id="consent-chk"> 본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.
            </label>
        </div>

        <div id="step-screener" class="hidden"> <p>연구 참여 기준 확인을 위해 정보를 입력해 주세요.</p>
            
            <div class="form-group">
                <label class="form-label">1. 귀하의 연령은?</label>
                <select class="form-control" id="age">
                    <option value="">선택하세요</option>
                    <option value="under18">만 18세 미만</option>
                    <option value="18-29">만 18세~29세</option>
                    <option value="30-39">만 30세~39세</option>
                    <option value="over40">만 40세 이상</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">2. 현재 거주지는?</label>
                <select class="form-control" id="residence">
                    <option value="">선택하세요</option>
                    <option value="korea">대한민국</option>
                    <option value="abroad">대한민국 외 지역</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">3. 성적 지향은?</label>
                <select class="form-control" id="orientation">
                    <option value="">선택하세요</option>
                    <option value="homo">동성애자(레즈비언, 게이)</option>
                    <option value="bi">양성애자(바이섹슈얼)</option>
                    <option value="hetero">이성애자</option>
                    <option value="other">그 외</option>
                    <option value="none">모름</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4. 성별 정체성은?</label>
                <select class="form-control" id="identity">
                    <option value="">선택하세요</option>
                    <option value="cis">시스젠더</option>
                    <option value="trans">트랜스젠더</option>
                    <option value="other">그 외</option>
                    <option value="none">모름</option>
                </select>
            </div>
            <p class="error-msg" id="screen-fail-msg">죄송합니다. 본 연구의 참여 대상 기준에 부합하지 않아 참여하실 수 없습니다.</p>
        </div>

        <div id="step-vignette" class="hidden">
            <div class="timer-container" id="timer-msg">
                <div class="timer-bar" id="timer-progress"></div>
                <div class="timer-text">⏳ 15초 뒤에 다음 버튼이 활성화됩니다.</div>
            </div>
            
            <div id="image-container">
                <img id="stimulus-img" src="" alt="상담실 이미지">
            </div>

            <div class="vignette-box">
                <p id="vignette-text" style="margin:0; font-size:16px; line-height:1.7;">
                    </p>
            </div>
            <p style="text-align:center; color:#999; font-size:13px; margin-top:10px;" id="page-counter">1 / 5</p>
        </div>

        <div id="step-check" class="hidden">
            <h2>기억 회상</h2>
            <p>방금 보신 상담실 장면을 떠올려 주세요.<br>벽이나 가구 주변에서 <strong>특히 기억에 남는 물건이나 표시</strong>가 있다면 선택해 주세요.</p>
            
            <div class="form-group" style="text-align: left; background: #fafafa; padding: 20px; border-radius: 8px;">
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="cross" onclick="toggleEtc(false)"> 십자가
                </label>
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="buddha" onclick="toggleEtc(false)"> 불상 (부처상)
                </label>
                <label class="radio-label" style="display:block; margin-bottom:10px; cursor:pointer;">
                    <input type="radio" name="check_opt" value="none" onclick="toggleEtc(false)"> 없음
                </label>
                <label class="radio-label" style="display:block; margin-bottom:0; cursor:pointer;">
                    <input type="radio" name="check_opt" value="etc" onclick="toggleEtc(true)"> 기타 (직접 입력)
                </label>
            </div>

            <input type="text" id="check-etc-text" class="form-control hidden" placeholder="기억나는 물건을 직접 적어주세요." style="margin-top: 10px;">
        </div>

        <div id="step-des" class="hidden">
            <h2>설문 1/2</h2>
            <p>방금 본 상담자에게 고민을 털어놓는 상황을 가정하고 응답해 주세요.<br>(1: 전혀 그렇지 않다 ~ 5: 매우 그렇다)</p>
            <div id="des-container">
            </div>
        </div>

        <div id="step-csq" class="hidden">
            <h2>설문 2/2</h2>
            <p>상담 경험 전반에 대해 만족하거나 도움이 될 것 같은 정도를 선택해 주세요.<br>(1: 전혀 아니다 ~ 7: 매우 그렇다)</p>
            <div id="csq-container">
            </div>
        </div>

<div id="step-debrief" class="hidden">
  <h2>참여해 주셔서 감사합니다.</h2>
  
  <div style="text-align: left; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <p style="margin-top:0;"><strong>[연구 목적 안내]</strong><br>
      본 연구는 상담 장면에서 <strong>상담실에 배치된 종교적 상징(개신교 십자가, 불상, 종교 상징물 없음)이 성소수자 내담자가 느끼는 안전감, 자기개방 기대, 상담 만족도에 어떤 영향을 미치는지</strong>를 알아보기 위한 실험이었습니다.
      이를 위해 모든 참가자에게 기본적으로 동일한 상담 장면 비네트를 제시하되, 상담실 이미지에 나타나는 종교 상징만 조건에 따라 달리 제시하였습니다.
    </p>

    <p>
      설문에 사용된 상담실 이미지는 실제 상담실 사진이 아니라, 연구 목적을 위해 <strong>생성형 인공지능(AI) 도구를 사용하여 제작한 이미지</strong>입니다. 상담자의 모습과 상담실의 전반적 분위기는 동일하게 유지한 채, 종교 상징(십자가, 불상, 없음)만 다르게 표현하도록 설계하였습니다.
    </p>

    <p>
      연구 과정에서 종교 상징의 효과를 미리 알리면 응답이 왜곡될 수 있어 동의서와 설문 시작 단계에서는 구체적인 연구 목적을 모두 밝히지 못한 점을 양해 부탁드립니다. 응답 내용은 모두 익명으로 처리되며, 개별 참가자를 식별할 수 없는 형태로만 연구에 사용됩니다. 이 설명을 들은 후 자신의 자료 사용을 원치 않는 경우, 아래 연구자 연락처로 알려주시면 즉시 자료를 삭제하겠습니다.
    </p>
    
    <p><strong>[문의 및 도움처]</strong><br>
      본 연구와 관련하여 문의사항이 있거나 연구 참여로 인한 불편감이 있는 경우 아래의 연구자에게 연락해 주십시오.
    </p>
    <p id="researcher-info" style="color:#0056b3; font-weight:bold;"></p>
    
    <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">
    
    <p style="font-size: 13px; color: #666; margin-bottom:5px;">
      추가적인 심리적 지원이 필요하신 경우 아래 기관을 이용하실 수 있습니다.
    </p>
    <ul style="font-size:13px; margin-top:0; color:#555;">
      <li>청소년 성소수자 위기지원센터 띵동: 02-924-1224</li>
      <li>한국생명의전화: 1588-9191</li>
      <li>정신건강상담전화: 1577-0199</li>
    </ul>
  </div>

  <div style="text-align: left; background: #fff3cd; padding: 20px; border-radius: 8px; border: 1px solid #ffeeba;">
    <p style="margin-top:0; font-weight:bold; color:#856404;">☕ 참여 보상 (선택 사항)</p>
    <p style="font-size:13px; color:#856404;">
      실험에 참여해 주신 분들께 소정의 커피 쿠폰을 드립니다.<br>
      원하시는 분은 핸드폰 번호를 입력해 주세요.<br>
      <span style="font-size:12px; color:#997404;">
        * 수집된 번호는 보상 제공 용도로만 사용되며, 지급 후 즉시 파기됩니다.<br>
        * 번호를 입력하지 않으셔도 실험은 정상적으로 종료되며 어떠한 불이익도 없습니다.
      </span>
    </p>
    <input type="tel" id="reward-phone" class="form-control" placeholder="01012345678 (숫자만 입력)">
  </div>

  <p style="margin-top:20px; font-size:13px; color:#666; text-align: center;">
    아래 버튼을 누르면 응답이 최종 제출되며 설문이 종료됩니다.
  </p>
</div>


    <div class="bottom-bar">
        <button id="main-btn" class="footer-btn" onclick="handleNext()">다음 ></button>
    </div>
</div>

<script>
    // ▼▼▼▼▼▼ [중요] 구글 스크립트 URL을 따옴표 안에 넣어주세요 ▼▼▼▼▼▼
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5u3GaICzyfh5Ybxj15oWppBfxWRb0g7UC5eMY8FxzGRUqkAest-yQgxeg2PW2goOf/exec"; 
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    // ▼▼▼▼▼▼ [설정] 연구자 연락처를 여기에 적으세요 ▼▼▼▼▼▼
    const RESEARCHER_CONTACT = "연구자 김윤서 (이메일: pape5344@daegu.ac.kr)";
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    /* --- 1. 실험 변수 및 상태 관리 --- */
    const conditions = ['cross', 'buddha', 'none']; 
    let state = {
        step: 'consent', // 시작 단계를 'consent'로 변경
        condition: '', 
        vignetteIndex: 0, 
        data: {}, 
        startTime: 0
    };

    const imgFiles = {
        'cross': 'cross.png',
        'buddha': 'buddha.png',
        'none': 'none.png'
    };

    const vignettes = [
        "당신은 최근 동성 파트너와의 반복되는 갈등으로 인해 더 이상 관계를 지속하기 힘들다고 느낍니다. 사소한 말다툼부터 이별, 재결합이 반복되면서 점점 지치고 외롭다는 느낌에 힘이 듭니다. 결국 상담센터를 찾아오기로 결심했고, 오늘은 이곳을 처음 방문한 날입니다.<br><br>대기실에서 상담자의 이력과 경력을 확인하며 어느 정도 전문성이 느껴져 약간 안심이 되었습니다. <br>곧 상담실로 들어가 당신의 이야기를 나누게 될 것입니다.",
        
        "당신은 안내를 받아 상담실로 들어가 상담자와 마주 보고 앉았습니다. <br>\"상담은 처음이라 많이 망설였어요.\"<br><br>상담자는 \"처음 오시는 자리라 많이 낯설 수 있습니다. 편한 만큼만 이야기해 주셔도 괜찮습니다\"라고 말하며 당신의 긴장을 풀어줍니다.",
        
        "\"애인과 몇 번이나 헤어지고 다시 만났는데, 도무지 잘 안 되는 것 같아요. 헤어지는 것도, 만나는 것도요.\"<br><br>당신은 조금 머뭇거리다 애인과의 관계에 대해 말합니다. <br>\"아무리 노력을 해도 달라지는 것도 없고.. 이제는 더 외로운 거 같아요.\"",
        
        "\"애인을 정말 많이 사랑해서 여러 번 참고 먼저 사과도 하셨는데, 관계가 달라지지 않아서 점점 지치고 외로워지셨던 것 같아요.\"<br><br>상담자는 고개를 끄덕이며 당신의 말을 되짚어 줍니다.<br><br>\"이 자리에서는 그런 마음들을 안전하게 편하게 이야기하실 수 있었으면 합니다\"라고 말하며, 지금 관계에서 특히 힘들었던 상황 한 가지를 함께 살펴보자고 제안합니다.",
        
        "당신은 상담자가 자신의 마음을 잘 이해해 준다는 느낌이 듭니다.<br>이 상담이 관계를 정리하거나 개선하는 데 실제로 도움이 될 수도 있겠다는 생각이 듭니다."
    ];

    const desQuestions = [
        "1. 당신의 개인적인 정보를 상담자에게 노출하는 것은 어려운 일일까요?",
        "2. 당신이 지금까지 아무에게도 말한 적이 없는 매우 사적인 일을 상담자에게 말한다면 불안하게 느껴질까요?",
        "3. 당신에게 슬프거나 괴로운 일이 생긴다면, 문제와 관련된 당신의 개인정보를 상담자에게 드러내는 것이 도움이 될까요?",
        "4. 당신의 숨겨둔 감정을 상담자에게 드러내는 것이 위험할까요?",
        "5. 상담자에게 부정적인 감정을 드러낼 때, 상담자가 무슨 생각을 할지 걱정되나요?",
        "6. 상담자에게 자신의 속마음을 말하는 것은 도움이 될까요?",
        "7. 만약 당신이 슬픔이나 불안 같은 감정을 상담자에게 노출한다면 기분이 나아질까요?",
        "8. 만약 당신이 고민 중인 정서적 문제를 상담자에게 드러낸다면 유용한 반응을 얻을 수 있을까요?"
    ];

    const csqQuestions = [
        "1. 이 상담은 훌륭한 상담이었다(일 것이다).",
        "2. 나는 이번 상담을 통해 내가 원하는 도움을 받았을 것이다.",
        "3. 이번 상담을 통해 나의 기대는 충족되었을 것이다.",
        "4. 내 친구가 나와 비슷한 고민을 한다면 이 상담을 추천할 것 같다.",
        "5. 나는 상담을 만족스럽게 끝냈을 것이다.",
        "6. 이번 상담은 내가 고민을 해결하고 극복하는 데 도움을 줄 것이다.",
        "7. 이번 상담은 전반적으로 나에게 만족스러울 것이다.",
        "8. 내가 상담을 받아야 할 필요가 있다면 이 상담자를 만나고 싶다."
    ];


    /* --- 2. 로직 함수 --- */

    function hideAllSteps() {
        document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
    }

    function handleNext() {
        const btn = document.getElementById('main-btn');

        // 1. 연구 동의 (가장 먼저 실행)
        if (state.step === 'consent') {
            if (!document.getElementById('consent-chk').checked) {
                alert('연구 참여에 동의하셔야 진행할 수 있습니다.');
                return;
            }
            
            // 동의 완료 -> 스크리너로 이동
            state.step = 'screener';
            hideAllSteps();
            document.getElementById('step-screener').classList.remove('hidden');
            document.getElementById('header-title').innerText = "기본 정보 입력";
            window.scrollTo(0,0);
        }

        // 2. 스크리너 단계 (두 번째 실행)
        else if (state.step === 'screener') {
            const age = document.getElementById('age').value;
            const residence = document.getElementById('residence').value;
            const orientation = document.getElementById('orientation').value;
            const identity = document.getElementById('identity').value;

            if (!age || !residence || !orientation || !identity) {
                alert('모든 항목을 선택해 주세요.');
                return;
            }

            // 포함 기준: 18세 이상(under18 제외), 한국 거주, 동성애/양성애, 시스젠더
            if (age === 'under18' || residence === 'abroad' || orientation === 'hetero' || identity !== 'cis') {
                document.getElementById('screen-fail-msg').style.display = 'block';
                return;
            }

            state.data.demographics = { age, residence, orientation, identity };
            
            // Randomization (스크리너 통과 후 배정)
            state.condition = conditions[Math.floor(Math.random() * conditions.length)];
            state.data.condition = state.condition;
            state.data.vignetteTime = [];
            console.log("Assigned Condition: " + state.condition);

            // 비네트로 이동
            state.step = 'vignette';
            state.vignetteIndex = 0;
            hideAllSteps();
            document.getElementById('step-vignette').classList.remove('hidden');
            document.getElementById('header-title').innerText = "상황 제시";
            
            renderVignette();
        }

        // 3. 비네트 진행
        else if (state.step === 'vignette') {
            const spentTime = Date.now() - state.startTime;
            state.data.vignetteTime.push(spentTime);

            state.vignetteIndex++;
            if (state.vignetteIndex < vignettes.length) {
                renderVignette();
            } else {
                state.step = 'check';
                hideAllSteps();
                document.getElementById('step-check').classList.remove('hidden');
                document.getElementById('header-title').innerText = "확인 문항";
            }
            window.scrollTo(0,0);
        }

        // 4. 조작 점검 제출
        else if (state.step === 'check') {
            const selectedOption = document.querySelector('input[name="check_opt"]:checked');
            
            if (!selectedOption) {
                alert('보기 중 하나를 선택해 주세요.');
                return;
            }

            let finalAnswer = selectedOption.value;
            if (finalAnswer === 'etc') {
                const etcText = document.getElementById('check-etc-text').value.trim();
                if (etcText.length < 1) {
                    alert('기타 내용을 입력해 주세요.');
                    return;
                }
                finalAnswer = '기타: ' + etcText;
            }

            state.data.check_answer = finalAnswer;

            renderScales('des', desQuestions, 5, 'step-des');
            state.step = 'des';
            hideAllSteps();
            document.getElementById('step-des').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (1/2)";
            window.scrollTo(0,0);
        }

        // 5. DES 제출
        else if (state.step === 'des') {
            if (!validateScale(desQuestions.length, 'des')) return;
            
            collectScaleData('des', desQuestions.length);
            
            renderScales('csq', csqQuestions, 7, 'step-csq');
            state.step = 'csq';
            hideAllSteps();
            document.getElementById('step-csq').classList.remove('hidden');
            document.getElementById('header-title').innerText = "설문 조사 (2/2)";
            window.scrollTo(0,0);
        }

        // 6. CSQ 제출 -> 디브리핑
        else if (state.step === 'csq') {
            if (!validateScale(csqQuestions.length, 'csq')) return;

            collectScaleData('csq', csqQuestions.length);

            state.step = 'debrief';
            hideAllSteps();
            document.getElementById('step-debrief').classList.remove('hidden');
            
            // 연구자 정보 입력 (자동)
            document.getElementById('researcher-info').innerText = RESEARCHER_CONTACT; 

            document.getElementById('header-title').innerText = "종료 및 안내";
            btn.innerText = "제출 및 종료";
            window.scrollTo(0,0);
        }

        // 7. 종료 및 구글 시트 전송
        else if (state.step === 'debrief') {
            sendDataToGoogle();
        }
    }

    /* 비네트 렌더링 & 시각적 타이머 적용 */
    function renderVignette() {
        const idx = state.vignetteIndex;
        const btn = document.getElementById('main-btn');
        const imgContainer = document.getElementById('image-container');
        const imgEl = document.getElementById('stimulus-img');
        const timerContainer = document.getElementById('timer-msg');
        const timerProgress = document.getElementById('timer-progress');

        document.getElementById('vignette-text').innerHTML = vignettes[idx];
        document.getElementById('page-counter').innerText = `${idx + 1} / 5`;

        if (idx === 0) {
            imgContainer.style.display = 'none';
        } else {
            imgContainer.style.display = 'block';
            imgEl.src = imgFiles[state.condition];
        }

        // 버튼 비활성화
        btn.disabled = true;
        btn.innerText = "지문을 읽어주세요. (15초)";
        timerContainer.style.visibility = 'visible';
        
        // --- 타이머 바 애니메이션 리셋 ---
        timerProgress.style.transition = 'none'; // 애니메이션 끄고
        timerProgress.style.width = '100%'; // 꽉 채우기
        
        // 브라우저가 스타일 변경을 인식하도록 강제 리플로우 (매우 중요)
        void timerProgress.offsetWidth; 

        // 애니메이션 시작 (15초 동안 0%로)
        timerProgress.style.transition = 'width 15s linear';
        timerProgress.style.width = '0%';
        // --------------------------------

        state.startTime = Date.now();
        
        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = "다음 >";
            timerContainer.style.visibility = 'hidden'; // 타이머 숨김
        }, 15000); // 15초
    }

    /* 구글 스프레드시트 데이터 전송 (백업 파일 삭제됨) */
    function sendDataToGoogle() {
        const btn = document.getElementById('main-btn');
        const phoneInput = document.getElementById('reward-phone').value.trim();
        
        if(GOOGLE_SCRIPT_URL.length < 10) {
            alert("오류: 구글 스크립트 URL이 설정되지 않았습니다.\n(백업 파일 저장 기능은 비활성화되어 있습니다)");
            return;
        }

        btn.disabled = true;
        btn.innerText = "데이터 저장 중...";

        const finalData = {
            id: Date.now(),
            condition: state.data.condition,
            demographics: state.data.demographics,
            vignetteTime: state.data.vignetteTime,
            check_answer: state.data.check_answer,
            des: state.data.des,
            csq: state.data.csq,
            phone: phoneInput 
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(finalData)
        })
        .then(() => {
            alert("데이터가 성공적으로 제출되었습니다.\n참여해 주셔서 감사합니다.");
            document.querySelector('.app-container').innerHTML = 
                "<div style='padding:40px; text-align:center;'><h2>실험 종료</h2><p>수고하셨습니다.<br>창을 닫으셔도 됩니다.</p></div>";
        })
        .catch(error => {
            console.error("Error:", error);
            // 백업 저장 로직 삭제됨
            alert("데이터 전송 중 오류가 발생했습니다.\n연구자에게 문의해 주세요.");
            document.querySelector('.app-container').innerHTML = 
                "<div style='padding:40px; text-align:center;'><h2>오류 발생</h2><p>데이터 전송에 실패했습니다.<br>창을 닫으셔도 됩니다.</p></div>";
        });
    }

    /* 척도 렌더링 */
    function renderScales(prefix, questions, maxScale, containerId) {
        const container = document.getElementById(containerId === 'step-des' ? 'des-container' : 'csq-container');
        container.innerHTML = "";

        questions.forEach((q, index) => {
            let html = `<div class="scale-group">
                <span class="scale-question">${q}</span>
                <div class="scale-options">`;
            
            for(let i=1; i<=maxScale; i++) {
                html += `
                    <label class="scale-option">
                        <input type="radio" name="${prefix}_q${index}" value="${i}">
                        ${i}
                    </label>`;
            }
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    /* 척도 유효성 검사 */
    function validateScale(count, prefix) {
        for(let i=0; i<count; i++) {
            if (!document.querySelector(`input[name="${prefix}_q${i}"]:checked`)) {
                alert(`${i+1}번 문항에 응답해 주세요.`);
                return false;
            }
        }
        return true;
    }

    /* 척도 데이터 수집 */
    function collectScaleData(prefix, count) {
        state.data[prefix] = [];
        for(let i=0; i<count; i++) {
            const val = document.querySelector(`input[name="${prefix}_q${i}"]:checked`).value;
            state.data[prefix].push(val);
        }
    }

    /* 기타 입력창 토글 */
    function toggleEtc(isShow) {
        const etcInput = document.getElementById('check-etc-text');
        if (isShow) {
            etcInput.classList.remove('hidden');
            etcInput.focus();
        } else {
            etcInput.classList.add('hidden');
            etcInput.value = "";
        }
    }
</script>

</body>
</html>

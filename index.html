<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 온라인 실험</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 디자인 시스템 --- */
        :root {
            --primary-color: #5bc2e7;
            --primary-dark: #2db6e0;
            --header-bg: #343a40;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #333333;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            overflow: hidden; 
            color: var(--text-main);
        }

        .app-container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
        }

        /* 헤더 */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            flex-shrink: 0;
            z-index: 200;
        }
        .close-btn { cursor: pointer; font-size: 14px; color: #ccc; }

        /* 컨텐츠 영역 (스크롤 가능 영역) */
        .content {
            flex: 1;
            padding: 0 24px 120px 24px; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* 상단 고정 이미지 박스 */
        .sticky-top-box {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--card-bg);
            padding-top: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sticky-top-box img {
            max-height: 25vh;
            max-width: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        h2 { font-size: 20px; margin-bottom: 20px; color: #222; margin-top: 20px; }
        p, label, li { font-size: 15px; line-height: 1.6; color: #444; }

        .hidden { display: none !important; }

        /* 입력 폼 */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 15px; box-sizing: border-box;
        }
        
        /* 하단 버튼 */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px; /* app-container와 동일하게 설정 */
            margin: 0 auto;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            z-index: 300;
        }

        .footer-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 18px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }
        #prev-btn { flex: 1; background-color: #a0a0a0; border-right: 1px solid #ddd; display: none; }
        #main-btn { flex: 2; }

        .footer-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .footer-btn:hover:not(:disabled) { filter: brightness(0.9); }

        .vignette-box {
            background: #fafafa; padding: 20px; border-radius: 8px; 
            border-left: 4px solid var(--primary-color);
            min-height: 120px;
        }

        .speaker { font-weight: bold; margin-right: 5px; color: #000; }
        .inner-thought { color: #555; font-style: italic; background-color: #fff; padding: 10px; border-radius: 5px; display: block; margin: 10px 0; border: 1px dashed #ddd; }
        .desc { color: #333; margin-bottom: 15px; display: block; font-weight: bold; }
        .dialogue { margin-bottom: 15px; display: block; }

        /* 척도 질문 */
        .scale-group { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .scale-question { font-weight: 500; margin-bottom: 10px; display: block; }
        .scale-options { display: flex; justify-content: space-between; margin-top: 10px; }
        .scale-option { text-align: center; font-size: 12px; cursor: pointer; flex: 1; }
        .scale-option input { display: block; margin: 0 auto 5px; transform: scale(1.2); }
        
        /* 안내 박스 스타일 */
        .info-box {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #0d47a1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span id="header-title">연구 참여 동의</span>
        <span class="close-btn" onclick="handleExit()">나가기 X</span>
    </header>

    <div class="content">
        <div id="step-consent"> 
            <h2>연구 참여 동의서</h2>
            <div style="background:#fafafa; max-height: 220px; overflow-y: auto; padding:15px; margin-bottom:20px; border:1px solid #eee;">
                본 연구는 상담 장면에서 내담자가 경험하는 인지 및 정서적 반응과 상담 만족도에 영향을 미치는 요인을 알아보기 위한 것입니다. 귀하는 온라인으로 제시되는 상담 장면(상담실 이미지와 상담과 관련된 대본)을 읽고, 해당 장면에 대한 인상과 예상되는 상담 경험에 대해 응답하게 됩니다.<br><br>
                이 설문은 전체 응답 기준으로 약 5~10분 정도 소요될 것으로 예상됩니다.<br><br>
                이 설문에는 동성 파트너와의 관계, 정서 경험, 상담에 대한 생각 등 민감할 수 있는 내용이 포함될 수 있습니다. 응답은 각 문항에 순서대로 답하는 방식으로 진행되며, 개별 문항을 건너뛰는 기능은 제공되지 않습니다. 다만 설문 참여 중단을 원하실 경우에는 언제든지 설문 창을 닫거나 “나가기” 버튼을 눌러 참여를 중단하실 수 있으며, 이로 인한 어떠한 불이익도 발생하지 않습니다.<br><br>
                수집된 모든 응답은 연구 목적을 위한 통계 분석에만 사용되며, IP 주소 등 개인을 식별할 수 있는 정보는 저장되지 않습니다. 연구 결과는 논문 및 학술 발표 등으로 보고되지만 개별 참가자를 식별할 수 있는 형태로 공개되지는 않습니다. 분석이 완료된 후에는 연구계획서에 명시된 기간 동안 암호화된 형태로 보관되었다가 안전한 방식으로 폐기됩니다.<br><br>
                설문 참여 과정에서 불편감이나 심리적 어려움을 느끼실 경우, 자살예방 상담전화(109), 생명의전화(1588-9191), 정신건강상담전화(1577-0199) 등의 공공 상담·지원 기관을 이용하실 수 있습니다.
            </div>
            <label>
                <input type="checkbox" id="consent-chk"> 본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.
            </label>
        </div>

        <div id="step-screener" class="hidden"> 
            <p>연구 참여 기준 확인을 위해 정보를 입력해 주세요.</p>
            
            <div class="form-group">
                <label class="form-label">1. 귀하의 연령은?</label>
                <select class="form-control" id="age">
                    <option value="">선택하세요</option>
                    <option value="under18">만 18세 미만</option>
                    <option value="18-29">만 18세~29세</option>
                    <option value="30-39">만 30세~39세</option>
                    <option value="over40">만 40세 이상</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">2. 현재 거주하고 있는 곳은 어디입니까?</label>
                <select class="form-control" id="residence">
                    <option value="">선택하세요</option>
                    <option value="korea">대한민국</option>
                    <option value="abroad">대한민국 외 지역</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">3. 당신의 성적지향은 무엇입니까?</label>
                <select class="form-control" id="orientation">
                    <option value="">선택하세요</option>
                    <option value="homo">동성애자(레즈비언, 게이)</option>
                    <option value="bi">양성애자(바이섹슈얼)</option>
                    <option value="hetero">이성애자</option>
                    <option value="other">그 외</option>
                    <option value="none">모름</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-1. 귀하의 출생 시 법적/생물학적 성별은 무엇입니까?</label>
                <select class="form-control" id="birth_sex" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Male)</option>
                    <option value="female">여성 (Female)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">4-2. 귀하가 현재 인식하는 성별 정체성은 무엇입니까?</label>
                <select class="form-control" id="current_gender" onchange="checkGenderIdentity()">
                    <option value="">선택하세요</option>
                    <option value="male">남성 (Male)</option>
                    <option value="female">여성 (Female)</option>
                    <option value="nonbinary">논바이너리 (Non-binary)</option>
                    <option value="other">기타 (그 외 다른 정체성)</option>
                </select>
            </div>
            <input type="hidden" id="final_identity_value" value="">
        </div>

        <div id="step-instruction" class="hidden">
            <h2>실험 진행 안내</h2>
            <div class="info-box">
                <p style="margin-top:0; font-weight:bold;">[잠시 후 실험 장면이 제시됩니다]</p>
                <ul style="padding-left: 20px; margin-bottom:0;">
                    <li>귀하는 <strong>상담실 이미지</strong>와 상담자와 나의 <strong>대화 내용</strong>을 보게 됩니다.</li>
                    <li><strong>각 화면은 최소 3초가 지나야 다음으로 넘어갈 수 있습니다.</strong></li>
                    <li>화면을 주의 깊게 본 후 이후 물음에 답해 주세요.</li>
                    <li>준비가 되셨다면 아래 <strong>'다음'</strong> 버튼을 눌러 시작해 주세요.</li>
                </ul>
            </div>
        </div>

        <div id="step-vignette" class="hidden">
            <div class="sticky-top-box" id="vignette-sticky-header">
                <div id="image-container-vig">
                    <img id="stimulus-img" src="" alt="상담실 이미지">
                </div>
            </div>

            <div class="vignette-box">
                <p id="vignette-text" style="margin:0; font-size:16px; line-height:1.7;">
                    </p>
            </div>
            <p style="text-align:center; color:#999; font-size:13px; margin-top:10px;" id="page-counter">1 / 7</p>
        }

        // 이전 버튼 관리: 0번 인덱스에서만 비활성화
        btnPrev.style.display = 'block';
        btnPrev.disabled = (idx === 0);
        
        // 타이머 재시작
        startVignetteTimer();
    }

    /* --- [로직] 메인 네비게이션 --- */
    function handleNext() {
        const btn = document.getElementById('main-btn');
        const prevBtn = document.getElementById('prev-btn');
        const currentStep = state.step;

        // 1. 동의
        if (currentStep === 'consent') {
            if (!document.getElementById('consent-chk').checked) { alert('연구 참여에 동의하셔야 진행할 수 있습니다.'); return; }
            state.step = 'screener'; showStep('step-screener', '기본 정보 입력');
            btn.innerText = "참여 기준 확인"; prevBtn.style.display = 'none';
        }

        // 2. 스크리너
        else if (currentStep === 'screener') {
            const inputs = ['age', 'residence', 'orientation', 'birth_sex', 'current_gender'];
            if (inputs.some(id => !document.getElementById(id).value)) { alert('모든 항목을 선택해 주세요.'); return; }
            
            const demo = { age: document.getElementById('age').value, residence: document.getElementById('residence').value, orientation: document.getElementById('orientation').value, birthSex: document.getElementById('birth_sex').value, currentGender: document.getElementById('current_gender').value, identity: document.getElementById('final_identity_value').value };
            state.data.demographics = demo;

            if (demo.age === 'under18' || demo.residence === 'abroad' || (demo.orientation !== 'homo' && demo.orientation !== 'bi') || demo.identity !== 'cis') { handleScreenFail(); return; }

            state.data.condition = state.condition; state.data.vignetteTime = [];
            state.step = 'instruction'; showStep('step-instruction', '실험 안내');
            btn.innerText = "시작";
        }

        // 3. 실험 안내 -> 비네트
        else if (currentStep === 'instruction') {
            state.step = 'vignette'; showStep('step-vignette', '상황 제시');
            btn.innerText = "다음 (3)"; prevBtn.style.display = 'block';
            renderVignette();
        }

        // 4. 비네트 진행
        else if (currentStep === 'vignette') {
            if (btn.disabled) return; 

            const spentTime = Date.now() - state.startTime;
            state.data.vignetteTime.push(spentTime);
            
            state.vignetteIndex++;

            if (state.vignetteIndex < vignettes.length) {
                renderVignette();
            } else {
                // 비네트 끝 -> 조작 확인
                state.step = 'check'; showStep('step-check', '설문 3/3 (조작 확인)');
                btn.innerText = "다음"; prevBtn.style.display = 'none';
            }
        }

        // 5. 조작 확인 -> DES
        else if (currentStep === 'check') {
            const selectedOption = document.querySelector('input[name="check_opt"]:checked');
            if (!selectedOption) { alert('보기 중 하나를 선택해 주세요.'); return; }

            let finalAnswer = selectedOption.value;
            if (finalAnswer === 'etc') {
                 const etcText = document.getElementById('check-etc-text').value.trim();
                 if (etcText.length < 1) { alert('기타 내용을 입력해 주세요.'); return; }
                 finalAnswer = '기타: ' + etcText;
            }
            state.data.check_answer = finalAnswer;

            document.getElementById('des-ref-img').src = imgFiles[state.condition];
            state.step = 'des'; showStep('step-des', '설문 1/3 (DES)');
            btn.innerText = "다음 (CSQ)";
        }

        // 6. DES -> CSQ
        else if (currentStep === 'des') {
            if (!validateScale(desQuestions.length, 'des')) return;
            collectScaleData('des', desQuestions.length);

            document.getElementById('csq-ref-img').src = imgFiles[state.condition];
            state.step = 'csq'; showStep('step-csq', '설문 2/3 (CSQ)');
            btn.innerText = "다음";
        }
        
        // 7. CSQ -> 디브리핑 (최종 제출)
        else if (currentStep === 'csq') {
            if (!validateScale(csqQuestions.length, 'csq')) return;
            collectScaleData('csq', csqQuestions.length);

            state.step = 'debrief'; showStep('step-debrief', '종료 및 안내');
            btn.innerText = "제출 및 종료";
        }

        // 8. 최종 종료
        else if (currentStep === 'debrief') {
            sendDataToGoogle();
        }
    }

    /* --- [로직] 이전 버튼 처리 --- */
    function handlePrev() {
        const currentStep = state.step;
        
        if (currentStep === 'vignette' && state.vignetteIndex > 0) {
            state.vignetteIndex--; 
            renderVignette(); 
        }
        // 다른 단계로의 이전 버튼 처리는 현재 디자인 상 불필요
    }

    /* --- [로직] 구글 전송 (최종 제출) --- */
    function sendDataToGoogle() {
        const btn = document.getElementById('main-btn');
        const phoneInput = document.getElementById('reward-phone').value.trim();
        
        btn.disabled = true;
        btn.innerText = "결과 보내는 중...";

        const finalData = {
            id: state.data.id, 
            condition: state.condition, 
            demographics: state.data.demographics,
            check_answer: state.data.check_answer,
            des: state.data.des, 
            csq: state.data.csq, 
            phone: phoneInput, 
            ip: state.userIP
        };

        fetch(GOOGLE_SCRIPT_URL, { 
            method: "POST", 
            body: JSON.stringify(finalData) 
        })
        .then(response => response.json())
        .then(response => {
            if (response.status === 'success') {
                localStorage.setItem('participation_completed', 'true');
                showStep('step-complete', '제출 완료');
            } else {
                throw new Error(response.message || "Unknown Error");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showStep('step-error', '오류 발생');
        });
    }

    /* --- [유틸] 척도 데이터 관리 (문항 생성) --- */
    function renderScales() {
        const desContainer = document.getElementById('des-container');
        const csqContainer = document.getElementById('csq-container');
        
        // DES 문항 생성 (5점 척도)
        desContainer.innerHTML = desQuestions.map((q, i) => `<div class="scale-group"><span class="scale-question">${q}</span><div class="scale-options">${Array(5).fill(0).map((_, j) => `<label class="scale-option"><input type="radio" name="des_q${i}" value="${j+1}" required>${j+1}</label>`).join('')}</div></div>`).join('');

        // CSQ 문항 생성 (7점 척도)
        csqContainer.innerHTML = csqQuestions.map((q, i) => `<div class="scale-group"><span class="scale-question">${q}</span><div class="scale-options">${Array(7).fill(0).map((_, j) => `<label class="scale-option"><input type="radio" name="csq_q${i}" value="${j+1}" required>${j+1}</label>`).join('')}</div></div>`).join('');
    }

    function validateScale(count, prefix) {
        for(let i=0; i<count; i++) {
            if (!document.querySelector(`input[name="${prefix}_q${i}"]:checked`)) {
                alert(`${i+1}번 문항에 응답해 주세요.`);
                const qEl = document.getElementsByName(`${prefix}_q${i}`)[0];
                qEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }
        }
        return true;
    }

    function collectScaleData(prefix, count) {
        state.data[prefix] = [];
        for(let i=0; i<count; i++) {
            state.data[prefix].push(document.querySelector(`input[name="${prefix}_q${i}"]:checked`).value);
        }
    }

    function toggleEtc(isShow) {
        const etcInput = document.getElementById('check-etc-text');
        if (isShow) {
            etcInput.classList.remove('hidden');
            etcInput.focus();
        } else {
            etcInput.classList.add('hidden');
            etcInput.value = "";
        }
    }

    function handleExit() {
        if (confirm("정말로 실험을 중단하고 나가시겠습니까?\n지금 나가시면 결과가 전송되지 않습니다.")) {
            window.open('','_self').close(); 
            window.close();
            document.querySelector('.app-container').innerHTML = `<div style='padding:40px; text-align:center;'><h2>종료</h2><p>창을 닫아주세요.</p></div>`;
        }
    }
</script>

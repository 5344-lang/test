<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 온라인 실험</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 디자인 시스템 --- */
        :root { --primary-color: #5bc2e7; --header-bg: #343a40; --bg-color: #f5f5f5; --card-bg: #ffffff; --text-main: #333333; }
        html, body { height: 100%; margin: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; overflow: hidden; color: var(--text-main); }
        .app-container { background-color: var(--card-bg); width: 100%; max-width: 500px; height: 100%; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        header { background-color: var(--header-bg); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 500; flex-shrink: 0; z-index: 200; }
        .close-btn { cursor: pointer; font-size: 14px; color: #ccc; }
        .content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; padding: 0 24px 120px 24px; }
      
/* 비네트(실험) 단계에서 여백을 완전히 제거 */
.content.full-screen-mode { 
    padding: 0 !important; 
    margin: 0 !important;
    height: 100vh; 
    width: 100%;
    overflow: hidden; 
}

/* 이미지 컨테이너: 화면 전체를 채우도록 설정 */
#step-vignette, #image-container-vig { 
    width: 100%; 
    height: 100%; 
    position: absolute; 
    top: 0;
    left: 0;
    background-color: #000;
}

#stimulus-img { 
    /* 1. 비율 유지하며 찌그러짐 방지 */
    width: 140% !important;   /* 화면보다 넓게 설정하여 이동할 공간 확보 */
    height: 100% !important; 
    object-fit: cover !important; 
    
    /* 2. 위치 조정 (왼쪽으로 이동시키려면 수치를 낮추세요) */
    /* 0%에 가까울수록 이미지의 왼쪽 끝이 보입니다. */
    object-position: 65% center !important; 
    
    /* 3. 중앙 정렬 유지 */
    position: absolute;
    left: 50%;
    transform: translateX(-50%); /* 크게 키운 이미지를 중앙에 배치 */
    
    display: block;
}

/* 대화창: 이미지 위에 뜨도록 절대 위치 고정 */
.vn-text-box {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    /* 아래 패딩을 70px 정도로 줄여 대사가 화면 아래쪽에 더 붙게 합니다 */
    padding: 30px 30px 85px 30px; 
    box-sizing: border-box;
    z-index: 10;
    transition: opacity 0.5s ease-in-out, background 0.3s ease;
    word-break: keep-all;
    /* 대사창 자체가 너무 높게 올라오지 않도록 최소 높이 제거 */
    min-height: auto; 
}

/* 상담자일 때 배경 (파란색 계열) */
.vn-text-box.speaker-counselor {
    background: linear-gradient(to top, rgba(0, 50, 100, 0.9) 5%, rgba(0, 50, 100, 0.6) 70%, transparent 100%);
}

/* 나일 때 배경 (초록색 계열) */
.vn-text-box.speaker-me {
    background: linear-gradient(to top, rgba(0, 80, 40, 0.9) 5%, rgba(0, 80, 40, 0.6) 70%, transparent 100%);
}

/* 해설/기본 배경 (기존 검정색) */
.vn-text-box.speaker-default {
    background: linear-gradient(to top, rgba(0,0,0,0.8) 5%, rgba(0,0,0,0.6) 70%, transparent 100%);
}


/* 유효한 값이 선택되었을 때 입혀질 클래스 (흰색 배경) */
select.form-control.selected {
    background-color: #ffffff !important; /* 흰색 배경 */
    color: #333; /* 글자색 진하게 */
}
.vn-text-box p { font-size: 16px; line-height: 1.6; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); margin: 0; }

/* 이름 표시: 노란색(#ffeb3b)에서 흰색(#ffffff)으로 수정 */
.speaker { font-weight: 700; color: #ffffff; margin-right: 8px; font-size: 17px; display: block; margin-bottom: 5px; }

#page-counter { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px; z-index: 20; }
        /* --- 설문 공통 스타일 --- */
        .sticky-top-box { position: sticky; top: 0; z-index: 100; background-color: var(--card-bg); padding: 15px 0; border-bottom: 2px solid #f0f0f0; margin-bottom: 20px; text-align: center; }
        .sticky-top-box img { max-height: 20vh; max-width: 100%; object-fit: contain; }
        h2 { font-size: 18px; margin-bottom: 15px; color: #222; margin-top: 20px; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        .hidden { display: none !important; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 15px; line-height: 1.4; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        
/* 하단 버튼 바 레이아웃 비율 조정 */
.bottom-bar { 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    max-width: 500px; 
    margin: 0 auto; 
    background: white; 
    border-top: 1px solid #eee; 
    display: flex; 
    z-index: 300; 
}

/* 이전 버튼 (20%) */
#prev-btn { 
    flex: 2; /* 비율 2 */
    background-color: #a0a0a0; 
    border-right: 1px solid #ddd; 
    display: block; /* 항상 노출 */
}

/* 다음 버튼 (80%) */
#main-btn { 
    flex: 8; /* 비율 8 */
}

.footer-btn { 
    background-color: var(--primary-color); 
    color: white; 
    border: none; 
    padding: 18px; 
    font-size: 16px; 
    font-weight: bold; 
    cursor: pointer; 
    text-align: center; 
    transition: opacity 0.2s;
}

.footer-btn:disabled { 
    background-color: #ccc; 
    cursor: not-allowed; 
}

/* 리커트 척도 숫자 버튼 스타일 */
.scale-options {
    display: flex;
    justify-content: space-between;
    border: 1px solid #ccc; /* 바깥 테두리 */
    border-radius: 8px;
    overflow: hidden;
    margin: 15px 0 8px 0;
}

.scale-option {
    flex: 1;
    position: relative;
    border-right: 1px solid #ccc; /* 숫자 사이 구분선 */
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
}

.scale-option:last-child { border-right: none; }

/* 라디오 버튼 숨기기 */
.scale-option input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    margin: 0;
}

/* 숫자 표시 */
.scale-number {
    display: block;
    padding: 15px 0;
    text-align: center;
    font-size: 16px;
    font-weight: 500;
    color: #333;
}

/* 선택되었을 때 배경색 변경 (파란색) */
.scale-option:has(input:checked) {
    background-color: var(--primary-color);
}

/* 선택된 숫자는 하얗게 */
.scale-option:has(input:checked) .scale-number {
    color: #fff;
    font-weight: bold;
}

/* 하단 라벨 정렬 교정 */
.scale-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    padding: 0 2px;
}

.scale-labels span {
    font-size: 12px;
    color: #666;
    flex: 1;
}

/* 1번 밑으로 */
.scale-labels span:first-child { text-align: left; }
/* 중간 */
.scale-labels span:nth-child(2) { text-align: center; }
/* 7번 밑으로 */
.scale-labels span:last-child { text-align: right; }

/* 전체 컨테이너 패딩: 하단 여백을 버튼 높이(약 80px)만큼만 잡습니다 */
.content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
    padding: 0 24px 80px 24px !important; /* 기존 120px에서 80px로 수정 */
}

/* 스크롤 박스 높이 고정 및 레이아웃 충돌 방지 */
#consent-scroll-box {
    height: 40vh;
    min-height: 200px;
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    background: #ffffff;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.6;
    color: #444;
    display: block; /* 영역 확보 확인 */
    -webkit-overflow-scrolling: touch;
}

/* 동의 옵션 박스 위치 확실히 확보 */
.consent-options {
    margin-top: 10px;
    margin-bottom: 30px; /* 다음 버튼과의 간격 확보 */
    padding: 15px;
    background: #f0f4f8;
    border-radius: 8px;
    position: relative;
    z-index: 10;
}
/* 문단 간격 조정 */
#consent-scroll-box p {
    margin-bottom: 15px;
}

/* 동의 라디오 버튼 박스 */
.consent-options {
    flex-shrink: 0; /* 높이가 줄어들지 않도록 고정 */
    padding: 15px;
    background: #f0f4f8;
    border-radius: 8px;
    margin-bottom: 5px; /* 하단 버튼과의 미세 간격 */
}
        /* 1. 팝업 배경 딤 처리 강화 (배경을 더 어둡게) */
#guide-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* 배경 투명도를 0.85로 높여 더 어둡게 */
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(2px); /* 배경을 살짝 흐리게 처리 */
}

/* 2. 척도 문항 간 간격 추가 및 구분선 */
.scale-group {
    margin-bottom: 45px; /* 문항 사이 간격을 넉넉히 벌림 */
    padding-bottom: 20px;
    border-bottom: 1px solid #eee; /* 문항 사이 흐린 구분선 추가 */
}

.scale-group:last-child {
    border-bottom: none; /* 마지막 문항 아래 선은 제거 */
}

/* 문항 제목(질문) 스타일 보완 */
.scale-question {
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 15px !important;
    display: block;
    word-break: keep-all;
}
    </style>
</head>
<body>

<div class="app-container">
    <header><span id="header-title">연구 참여 동의</span><span class="close-btn" onclick="handleExit()">나가기 X</span></header>
    <div class="content" id="content-area">
        <div id="step-consent">
            <h2>연구 설명 및 동의서</h2>
            <div id="consent-scroll-box">
                <p>본 연구는 온라인으로 제시되는 상담 장면에 대한 평가를 통해, 상담 상황에서 내담자가 경험하는 자기개방 기대와 상담 회기·상담자에 대한 인식을 살펴보고자 하는 설문연구입니다.​</p>
                <p>귀하는 연구 참여 여부를 결정하기 전에 아래의 연구대상자 설명문과 동의서를 신중하게 읽어보셔야 합니다. 이 연구는 자발적으로 참여 의사를 밝히신 분에 한해서만 진행되며, 내용을 충분히 읽은 후 참여 여부를 결정하실 것을 권합니다. 필요하다면 가족이나 친구들과 상의하셔도 되고, 궁금한 점이 있을 경우 언제든지 담당 연구원에게 질문하실 수 있습니다.​</p>
                <p>귀하의 동의는 연구 내용과 잠재적 위험성에 대해 설명을 들었음을 의미합니다. 화면 하단의 “본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.” 버튼에 체크한 뒤 제출 버튼을 누르시면, 이는 서면 자필 서명을 대신하는 전자적 동의로 인정됩니다.​</p>
                <p>한국 사회에서 성적지향과 관련된 편견과 차별은 여전히 존재하며, 성소수자는 상담이나 심리적 도움을 필요로 하면서도 상담 장면에서 자신을 얼마나 안전하게 드러낼 수 있을지에 대해 많은 걱정을 느낄 수 있습니다.​</p>
                <p>이 연구는 온라인으로 제시되는 가상의 상담실 이미지와 상담 장면을 보고 평가해 주시는 과정을 통해, 상담 환경에 따라 내담자가 상담자에게 개인적이고 민감한 내용을 얼마나 편안하게 털어놓을 수 있을지, 그리고 상담 회기와 상담자에 대해 어떻게 느끼는지가 달라지는지를 살펴보고자 합니다.​</p>
                <p>응답에 영향을 줄 수 있는 세부 가설은 설문 시작 전에 모두 설명드리지는 않지만, 설문이 모두 끝난 뒤 별도의 안내 화면을 통해 사용된 상담실 이미지와 연구의 보다 자세한 목적을 설명해 드리는 디브리핑 절차가 제공됩니다.​​</p>
                <p>이 연구는 만 19세 이상의 성인 중, 스스로를 시스젠더로 정체화하고 동성에게 정서적·성적 끌림을 경험하는 레즈비언, 게이, 양성애자(LGB)에 해당한다고 생각하는 분을 대상으로 합니다.​</p>
                <p>포함 기준에 맞지 않는 경우에는 간단한 안내 후 설문이 종료되며, 해당 응답은 연구 분석에 사용되지 않습니다. 연구 참여 여부는 전적으로 자발적인 선택이며, 참여하지 않거나 중도에 중단하더라도 어떠한 불이익도 발생하지 않습니다.​</p>
                <p>만일 귀하가 참여 의사를 밝혀 주시면 다음과 같은 과정이 진행됩니다. 먼저 온라인 설문 링크에 접속하여 연구 목적과 절차, 민감정보 처리 및 익명성 보장에 대한 설명문을 읽으신 뒤, “연구 참여에 동의합니다” 버튼을 눌러 전자적 동의를 표시하게 됩니다. 동의 후에는 시스젠더 LGB 성소수자 내담자가 등장하는 상담센터 대기실·상담실 이미지와 함께 짧은 비네트가 제시됩니다. 비네트와 이미지를 모두 보신 뒤에는, 앞서 보신 상담자에게 고민을 털어놓는 상황을 떠올리면서 자기개방기대(위험·유용성)에 관한 문항과 상담회기평가(SEQ), 상담자평가(CRF‑S) 문항에 응답하시게 됩니다. 이어서 방금 보신 상담실 장면을 떠올리며 기억에 남는 물건(예: 십자가, 불상, 없음 등)을 선택하는 짧은 문항에 답하게 됩니다.</p>
                <p>귀하는 본 연구를 위해 단 한 번 온라인 설문과 시나리오 비네트 실험에 참여하도록 요청받을 것입니다. 전체 설문은 안내문과 동의 절차를 포함하여 약 10–15분 정도 소요됩니다.</p>
                <p>귀하가 이 연구에 참여하는 데 있어서 금전적 보상 외의 직접적인 의학적 이득은 없습니다. 그러나 귀하가 제공하는 응답 자료는 성소수자 내담자가 상담실의 종교적 상황단서를 어떻게 경험하는지, 그리고 이러한 환경이 자기개방기대와 상담평가에 어떤 영향을 미치는지에 대한 학문적 이해를 증진시키는 데 중요한 기여를 하게 됩니다. 이를 통해 장기적으로는 성소수자에게 보다 안전하고 포괄적인 상담 환경을 설계하고, 상담 현장에서의 차별과 소수자스트레스를 줄이기 위한 실제적 개입 방안을 마련하는 데 도움이 될 것입니다.</p>
                <p>상담 장면 비네트를 읽고 상담실 이미지를 보는 과정에서 자신의 경험과 연결된 불편함이나 불쾌한 감정이 유발될 수 있습니다. 이럴 경우 귀하는 언제든지 설문 응답과 연구 참여를 중단하실 수 있으며, 어떠한 불이익도 발생하지 않습니다. 만일 연구 참여 도중 발생할 수 있는 정서적 불편, 부작용이나 위험 요소에 대한 질문이 있으시면 안내문에 제시된 담당 연구원 연락처로 즉시 문의해 주시기 바랍니다.</p>
                <p>귀하가 연구에 참여하신 뒤, 설문 마지막에 답례품 수령을 위해 연락처(휴대전화번호) 입력 및 사용에 동의하신 경우에 한하여 커피 상품권이 지급될 것입니다.</p>
                <p>본 연구 참여로 귀하에게서 수집되는 개인정보는 연령, 성별 정체성(시스젠더 여부), 성적지향(레즈비언·게이·양성애자)과 같이 연구 분석에 필요한 최소한의 인구통계학적 정보입니다. 이 정보는 개별 응답자를 특정할 수 없도록 연구용 ID와 분리된 형태의 데이터 파일로 저장되며, 개인정보보호법에 따라 비밀번호가 설정된 전자 파일 형태로 안전하게 보관됩니다. 연구 데이터는 담당 연구자만 접근할 수 있도록 제한되며, 연구 종료 후에는 식별 가능한 정보가 완전히 삭제된 비식별(완전 데이터 삭제) 데이터만 학문적 목적을 위해 보존·활용됩니다.​</p>
                <p>연구를 통해 얻어진 결과가 학위논문, 학술지, 학회 발표 등의 형태로 공개될 수 있으나, 이 과정에서 귀하의 이름이나 연락처 등 개인을 직접 식별할 수 있는 정보는 일절 사용되지 않습니다. 다만 법령에서 요구하는 경우에는 관련 규정이 허용하는 범위 안에서 필요한 정보가 제공될 수 있으며, 이때에도 연구대상자의 비밀보장을 최대한 보호하기 위해 필요한 조치를 취합니다. 또한 생명윤리위원회 등 점검·모니터 기관은 연구 절차와 자료의 신뢰성 검증을 위해 연구 관련 자료의 열람을 요청할 수 있으나, 이 역시 관련 규정 범위 내에서 비밀보장을 침해하지 않는 선에서만 이루어집니다. 연구 종료 후 연구 관련 문서(위원회 심의결과, 동의 기록, 개인정보 수집·이용 현황 등)는 관련 법령이 정한 기간 동안 전자 데이터 형태로 보관한 뒤, 보관기간이 만료되면 복구가 불가능한 방식으로 완전 삭제될 예정입니다.</p>
                <p>귀하는 본 연구에 참여하지 않을 자유가 있으며, 참여 여부는 전적으로 자발적인 결정에 따라 이루어집니다. 연구에 참여하지 않더라도 귀하에게는 어떠한 불이익도 발생하지 않습니다. 또한 연구에 참여하신 후라도 언제든지 이유를 밝히지 않고 참여를 중단하실 수 있으며, 이 경우에도 불이익은 전혀 없습니다. 만일 연구 참여를 그만두고 싶으시다면 안내문에 제시된 담당 연구원 또는 연구책임자에게 이메일이나 기타 연락 수단을 통해 중지 의사를 알려 주시면 됩니다. 참여 중지 시, 귀하의 응답 데이터는 연구 데이터베이스에서 즉시 분리되며, 식별 가능한 정보와 연계된 원자료는 전자 파일상에서 복구가 불가능한 방식으로 완전히 삭제됩니다. 이미 통계적으로 완전히 익명화되어 개인을 전혀 식별할 수 없는 집계 데이터만 남게 되며, 추가 분석에는 귀하의 개별 자료가 더 이상 사용되지 않습니다.</p>
                <p>본 연구에 대해 질문이 있거나 연구 중간에 문제가 생길 시 다음 연구 담당자에게 언제든지 연락하십시오.</p>
                <p style="padding-left: 10px;">공동연구자: 김윤서<br>이메일: pape5344@daegu.ac.kr</p>
                <p style="padding-left: 10px;">책임연구자: 남상희<br>이메일: baskya@daegu.ac.kr</p>
                <p>만일 어느 때라도 연구대상자로서 귀하의 권리에 대한 질문이 있다면 다음의 대구대학교 생명윤리위원회에 연락하십시오.<br>대구대학교 생명윤리위원회 · 전화번호: 053-850-5140 · https://irb.daegu.ac.kr</p>
                <hr>
                <p>1. 나는 화면에 제시된 연구대상자 설명문을 읽었으며, 궁금한 점이 있을 경우 담당 연구원에게 문의하여 설명을 들을 수 있음을 이해하였습니다</p>
                <p>2. 나는 이 연구에 참여함으로써 예상되는 이익과 위험, 그리고 나의 권리에 대해 충분한 설명을 들었으며, 이해한 내용에 만족합니다.</p>
                <p>3. 나는 이 연구에 자발적으로 참여하기로 동의하며, 언제든지 이유를 밝히지 않고 참여를 중단할 수 있고, 이로 인해 어떠한 불이익도 발생하지 않는다는 사실을 알고 있습니다.​</p>
                <p>4. 나는 이 연구 과정에서 수집되는 정보가 현행 법률과 대구대학교 생명윤리위원회 규정이 허용하는 범위 내에서 연구 목적으로만 사용되며, 비식별 형태로 안전하게 보관·처리된다는 점을 이해하고 동의합니다.</p>
                <p>5. 나는 이 연구가 온라인 설문 형태로 진행되며, 연구자와 학교·생명윤리위원회가 연구의 적절한 수행 여부를 확인하기 위해 필요한 범위 안에서만 비식별 자료를 열람할 수 있음을 이해하고 이에 동의합니다.</p>
                <p>6. 나는 이 동의가 종이 서명이 아닌 전자적 방식으로 이루어지며, 화면 하단의 “본인은 위 내용을 숙지하였으며 연구 참여에 동의합니다.” 항목에 체크하고 설문을 시작하는 것이 자필 서명을 대신한다는 점을 이해합니다.</p>
</div>
            <div class="consent-options">
            <label style="cursor:pointer; display:flex; align-items:flex-start; margin-bottom:10px;">
                <input type="radio" name="consent_choice" value="agree" style="margin-top:5px; margin-right:10px;">
                <span style="font-weight:bold;">본인은 위 내용을 모두 읽고 이해했으며, 연구 참여에 동의합니다.</span>
            </label>
            <label style="cursor:pointer; display:flex; align-items:flex-start;">
                <input type="radio" name="consent_choice" value="disagree" style="margin-top:5px; margin-right:10px;">
                <span>본인은 위 내용을 모두 읽고 이해했으며, 연구 참여에 동의하지 않습니다.</span>
            </label>
        </div> </div>
        <div id="step-screener" class="hidden">
        <h2>1. 인구통계학적 질문지</h2>
            <div class="form-group">
                <label class="form-label">1. 귀하의 연령은? (만____세)</label>
               <input type="number" class="form-control" id="age" 
       placeholder="숫자로 입력하세요" 
       min="1" max="100" 
       oninput="this.value = this.value.replace(/[^0-9]/g, '');">
            </div>
            <div class="form-group">
                <label class="form-label">2. 현재 거주하고 있는 곳은 어디입니까?</label>
                <select class="form-control" id="residence">
                    <option value="" disabled selected hidden>선택하세요</option>
                    <option value="korea">대한민국</option>
                    <option value="abroad">대한민국 외 지역</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">3. 당신의 성적지향은 무엇입니까?</label>
                <select class="form-control" id="orientation">
                    <option value="" disabled selected hidden>선택하세요</option>
                    <option value="homo">동성애자(레즈비언, 게이)</option>
                    <option value="bi">양성애자(바이섹슈얼)</option>
                    <option value="hetero">이성애자</option>
                    <option value="other">그 외</option>
                    <option value="dontknow">모름</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">4-1. 귀하의 출생 시 법적/생물학적 성별은 무엇입니까?</label>
                <select class="form-control" id="birth_sex">
                    <option value="" disabled selected hidden>선택하세요</option>
                    <option value="male">남성 (Male, 男)</option>
                    <option value="female">여성 (Female, 女)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">4-2. 귀하가 현재 인식하는 성별 정체성은 무엇입니까?</label>
                <select class="form-control" id="current_gender">
                    <option value="" disabled selected hidden>선택하세요</option>
                    <option value="male">남성 (Male, 男)</option>
                    <option value="female">여성 (Female, 女)</option>
                    <option value="nonbinary">논바이너리 (Non-binary)</option>
                    <option value="other">기타 (그 외 다른 정체성)</option>
                </select>
            </div>
        </div>

        <div id="step-vignette" class="hidden">
            <div id="image-container-vig"><img id="stimulus-img" src=""></div>
            <div id="page-counter">1 / 22</div>
            <div class="vn-text-box"><p id="vignette-text"></p></div>
        </div>
        <div id="step-des-intro" class="hidden">
    <div class="sticky-top-box"><img id="des-intro-ref-img" src=""></div>
    <h2>5. 자기개방 기대 척도 (DES)</h2>
    <div class="intro-box">
        <p class="intro-text">다음 문항들은 앞서 보신 상담의 상담자에게 당신의 고민을 털어놓는 것에 대해 어떻게 기대하고 계신지를 묻는 질문입니다. 귀하께서는 어떻게 느끼셨는지, 그 정도를 나타내는 숫자에 표시해주십시오.<br><br>(1: 전혀 그렇지 않다 ~ 5: 매우 그렇다)</p>
        <div id="des-questions-preview" class="preview-content"></div>
    </div>
</div>
<div id="step-des" class="hidden">
    <div class="sticky-top-box"><img id="des-ref-img" src=""></div>
    <h2>5. 자기개방 기대 척도 (DES)</h2>
    <div id="des-container"></div>
</div>

<div id="step-seq-intro" class="hidden">
    <div class="sticky-top-box"><img id="seq-intro-ref-img" src=""></div>
    <h2>6. 상담회기평가 질문지 (SEQ)</h2>
    <div class="intro-box">
        <p class="intro-text">다음 문항들은 귀하께서 이 상담자와 진행된 상담시간에 대해 어떻게 느끼고 있는지 알아보고자 하는 것입니다. 각 문항마다 대조되는 단어가 쌍으로 제시되어 있으며, 귀하께서는 앞서 본 상담시간에 대해 어떻게 느끼셨는지, 그 정도를 나타내는 숫자에 표시해주십시오.<br><br>(1: 전혀 그렇지 않다 ~ 7: 매우 그렇다)
     </p>
        <div id="seq-questions-preview" class="preview-content"></div>
    </div>
</div>
<div id="step-seq" class="hidden">
    <div class="sticky-top-box"><img id="seq-ref-img" src=""></div>
    <h2>6. 상담회기평가 질문지 (SEQ)</h2>
     <p style="font-size:18px; color:#222; font-weight:bold; margin-bottom:20px; margin-top:10px;">앞서 본 상담 시간은, ___________했다.</p>
    <div id="seq-container"></div>
</div>

<div id="step-crf-intro" class="hidden">
    <div class="sticky-top-box"><img id="crf-intro-ref-img" src=""></div>
    <h2>7. 상담자 평가 질문지 (CRF-S)</h2>
    <div class="intro-box">
        <p class="intro-text">귀하께서 지금까지 상담자를 어떻게 보았는지, 그 정도를 가장 잘 나타내는 숫자에 표시하여 주세요.<br><br>(1: 전혀 그렇지 않다 ~ 7: 매우 그렇다)</p>
        <div id="crf-questions-preview" class="preview-content"></div>
    </div>
</div>
<div id="step-crf" class="hidden">
    <div class="sticky-top-box"><img id="crf-ref-img" src=""></div>
    <h2>7. 상담자 평가 질문지 (CRF-S)</h2>
<p style="font-size:18px; color:#222; font-weight:bold; margin-bottom:20px; margin-top:10px;">앞서 본 상담자는, __________했다.</p>
    <div id="crf-container"></div>
</div>

        <div id="step-check" class="hidden">
            <h2>8. 조작점검 문항</h2>
            <p class="form-label">※ 지금 보신 상담실 장면을 떠올려 주세요. 상담실에서 기억에 남는 물건이나 표시가 있다면 선택해 주세요.</p>
            <div class="form-group" style="background:#fafafa; padding:20px; border-radius:8px;">
                <label><input type="radio" name="check_opt" value="cross">십자가</label><br><br>
                <label><input type="radio" name="check_opt" value="buddha">불상(부처상)</label><br><br>
                <label><input type="radio" name="check_opt" value="none">없음</label><br><br>
                <label><input type="radio" name="check_opt" value="etc">기타 (직접 입력)</label>
                <input type="text" id="check-etc-input" class="form-control" style="margin-top:10px;" placeholder="내용을 입력하세요.">
            </div>
        </div>
        
<div id="step-religion-move" class="hidden">
    <h2>9.종교 질문</h2>
    <div class="form-group">
        <label class="form-label">귀하의 종교는 무엇입니까?</label>
        <select id="religion" class="form-control">
            <option value="" disabled selected hidden>선택하세요</option>
            <option value="가톨릭">가톨릭</option>
            <option value="개신교">개신교</option>
            <option value="불교">불교</option>
            <option value="무교">무교</option>
            <option value="기타">기타</option>
        </select>
    </div>
</div>
        
        <div id="step-debrief" class="hidden">
            <h2>10. 사후 설명 (Debriefing)</h2>
            <div id="debrief-scroll-box" style="background:#ffffff; height: 50vh; overflow-y: auto; padding:15px; border:1px solid #ccc; font-size:14px; line-height:1.7; color: #333; border-radius: 5px; margin-bottom: 20px;">
                <p>먼저, 연구에 끝까지 참여해 주셔서 감사합니다. 지금까지는 “온라인 상담 장면 평가 설문”이라는 이름으로 안내를 드렸습니다. 실제로는 한국 시스젠더 LGB 성소수자의 상담 경험을 이해하기 위해 상담실에 제시된 종교적 상황단서가 어떤 점화효과를 일으켜 상담에 대한 기대와 평가를 바꾸는지를 살펴보는 연구였습니다.</p>
                <p>이번 연구의 실제 목적은, 상담실 이미지 속 종교적 상황단서(기독교 십자가, 불교 불상, 종교 상징 없음)가 이러한 점화효과를 통해 시스젠더 LGB 성인 내담자의 자기개방 기대, 즉 상담자에게 개인적이고 민감한 이야기를 털어놓았을 때 예상하는 위험과 유용성 수준을 어떻게 변화시키는지 살펴보는 것입니다. 더 나아가, 이렇게 점화된 자기개방 기대의 변화가 상담 회기평가(SEQ: 깊이·순조로움)와 상담자평가(CRF‑S: 전문성·호감성·신뢰성)에 어떤 방식으로 반영되는지를 분석하여, 종교적 상황단서가 자기개방 기대를 매개로 상담 평가에 미치는 간접 효과를 검증하고자 합니다.​</p>
                <p>연구자는 이번 결과가 상담실 물리적·상징적 환경을 구성할 때, 특히 강하게 드러나는 종교 상징이 성소수자 내담자가 어떤 점화효과를 일으켜 심리적 안전감과 상담 경험을 변화시킬 수 있는지에 대한 실증적 근거를 제공할 것으로 기대하고 있습니다. 이를 통해 성소수자가 보다 편안하게 자기 이야기를 꺼낼 수 있는 포괄적 상담 환경을 설계하고, 상담 현장에서의 차별과 소수자스트레스를 줄이기 위한 실제적 개입 방안을 마련하는 데 도움이 되는 자료를 제시하고자 합니다.</p>
                <p>다시 한 번 연구에 끝까지 참여해 주셔서 진심으로 감사합니다. 이번 설문 과정에서 상담 장면이나 종교적 상징으로 인해 불쾌감, 슬픔, 분노, 불안을 포함한 정서적 불편을 느끼셨다면, 이는 매우 자연스러운 반응일 수 있습니다. 원하실 경우, 안내문에 제시된 연구자 연락처로 문의하셔서 자신의 자료 삭제를 요청하실 수 있으며, 연구자는 귀하의 요청을 최대한 빠르게 반영하겠습니다.​</p>
                <p>본 연구에 대해 질문이 있거나 문제가 생길 시 다음 연구 담당자에게 언제든지 연락하십시오.<br>
                연구담당자: 김윤서<br>
                긴급연락처: pape5344@daegu.ac.kr</p>
                <p>만일 어느 때라도 연구대상자로서 귀하의 권리에 대한 질문이 있다면 다음의 대구대학교 생명윤리위원회에 연락하십시오.<br>
                대구대학교 생명윤리위원회 · 전화번호: 053-850-5140 · https://irb.daegu.ac.kr</p>
            </div>

            <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeeba;">
                <p style="font-weight: bold; margin-top:0;">☕ 커피 기프티콘 증정 (선택 사항)</p>
                <p style="font-size: 13px; color: #856404; line-height: 1.5;">참여 보상 전송을 원하시는 분만 아래에 전화번호를 입력해 주세요. 입력된 번호는 기프티콘 전송 용도 외에는 사용되지 않고, 전송 후 번호정보는 완전히 폐기됩니다.</p>
                <input type="tel" id="reward-phone" class="form-control" placeholder="01012345678 (숫자만 입력)" maxlength="11">
            </div>
        </div>

<div id="step-complete" class="hidden"><h2 style="text-align:center; margin-top:100px;">제출이 완료되었습니다.<br>소중한 참여에 감사드립니다.</h2></div>
    </div>

    <div class="bottom-bar">
        <button id="prev-btn" class="footer-btn" onclick="handlePrev()">이전</button>
        <button id="main-btn" class="footer-btn" onclick="handleNext()">다음</button>
    </div>
</div>

<div id="guide-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; display:none; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:400px; padding:25px; border-radius:15px;">
        <h3 id="modal-title" style="margin-top:0; color:var(--header-bg); border-bottom:2px solid var(--primary-color); padding-bottom:10px;">안내</h3>
        <p id="modal-body" style="line-height:1.6; font-size:15px; color:#444; margin:20px 0;"></p>
        <button onclick="closeModal()" style="width:100%; background:var(--primary-color); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">확인하였습니다</button>
    </div>
</div>

<script>

    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfcRoQeVapXR-6506UqEuGun6gNsLNQV-SUK35vrhJr1WiefBb8pTtZmhI3x-YffA/exec";
    const imgFiles = { 'waiting': 'waiting.png', 'cross': 'cross.png', 'buddha': 'buddha.png', 'none': 'none.png' };
/* 1. 상태 변수 선언 (가장 먼저 선언하여 참조 오류 방지) */
let state = { 
    step: 'consent', 
    condition: ['cross', 'buddha', 'none'][Math.floor(Math.random()*3)], 
    vignetteIndex: 0,
    userId: null,
    isLocked: false // 시크릿 모드 판정 시 true로 변경됨
};

    /* [강화 1] 이미지 미리 로딩 함수 */
function startImagePreload() {
    console.log("배경에서 이미지 로딩을 시작합니다...");
    Object.values(imgFiles).forEach(src => {
        const img = new Image();
        img.src = src; 
    });
}

/* [최종 보완] 시크릿 모드 감지: IndexedDB 및 Quota 복합 체크 */
async function checkIncognito() {
    let isPrivate = false;

    try {
        // 1. 크롬 등 최신 브라우저용 (Quota 체크)
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            const { quota } = await navigator.storage.estimate();
            // 할당량이 120MB(크롬) 또는 특정 기준 이하일 때 의심
            if (quota < 120000000) isPrivate = true;
        }

        // 2. 사파리 및 구형 브라우저용 (IndexedDB 체크)
        // 시크릿 모드에서 IndexedDB 생성 시도 시 에러가 발생하는 특성을 이용
        if (!isPrivate) {
            isPrivate = await new Promise((resolve) => {
                const db = indexedDB.open("test");
                db.onerror = () => resolve(true); // 에러 발생 시 시크릿 모드로 간주
                db.onsuccess = () => resolve(false);
            });
        }
    } catch (e) {
        console.error("감지 과정 오류:", e);
    }

    // 결과 반영
    if (isPrivate) {
        state.isLocked = true;
        console.warn("시크릿 모드 감지됨");
        
        // UI 즉시 업데이트
        const mainBtn = document.getElementById('main-btn');
        if (mainBtn) {
            mainBtn.disabled = true;
            mainBtn.innerText = "접속 제한됨 (일반 창 권장)";
            mainBtn.style.backgroundColor = "#ff4d4d";
        }
        alert("본 연구는 데이터 중복 지원 방지를 위해 시크릿 모드에서의 접속을 제한하고 있습니다. 일반 브라우저 창으로 접속해 주시기 바랍니다.");
    }
}

    

async function getIP() {
    const providers = [
        'https://api64.ipify.org?format=json',
        'https://ipv4.icanhazip.com',
        'https://checkip.amazonaws.com'
    ];
    for (const url of providers) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000); // 5초로 연장
            
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(id);
            
            const data = await (url.includes('json') ? response.json() : response.text());
            let ip = (typeof data === 'object' ? data.ip : data).trim();
            
            if (ip) {
                console.log("IP 수집 성공:", ip);
                return ip;
            }
        } catch (e) {
            console.warn("IP 수집 시도 실패:", url);
            continue; 
        }
    }
    return null; 
}
    
/* 2. 데이터 전송 함수 (async/await 적용) */

async function sendData() {
    const btn = document.getElementById('main-btn');
    btn.disabled = true;
    btn.innerText = "제출 중";

    const userIP = await getIP(); // IP 가져오기 대기
    const checkOptEl = document.querySelector('input[name="check_opt"]:checked');
    let checkAns = checkOptEl ? checkOptEl.value : "미응답";
    if (checkAns === 'etc') checkAns = "기타: " + document.getElementById('check-etc-input').value;
    const results = {
        id: state.userId,
        ip: userIP, // IP 포함
        condition: state.condition,
        age: document.getElementById('age').value,
        residence: document.getElementById('residence').value,
        orientation: document.getElementById('orientation').value,
        birth_sex: document.getElementById('birth_sex').value,
        current_gender: document.getElementById('current_gender').value,
        religion: document.getElementById('religion').value,
        check_answer: checkAns,
        phone: document.getElementById('reward-phone').value || "",
        des_scores: Array.from({length:8}, (_,i) => document.querySelector(`input[name="des_q${i}"]:checked`).value).join(','),
        seq_scores: Array.from({length:10}, (_,i) => document.querySelector(`input[name="seq_q${i}"]:checked`).value).join(','),
        crf_scores: Array.from({length:12}, (_,i) => document.querySelector(`input[name="crf_q${i}"]:checked`).value).join(',')
    };
    fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", // 차단 없이 무조건 전송
        body: JSON.stringify(results)
    })
    .then(() => {
        localStorage.setItem('survey_finished', 'true');
        showStep('step-complete');
        document.querySelector('.bottom-bar').style.display = 'none';
    })
    .catch(() => {
       // no-cors 특성상 에러가 떠도 데이터는 전송됩니다.
       localStorage.setItem('survey_finished', 'true');
        showStep('step-complete');
        document.querySelector('.bottom-bar').style.display = 'none';
    });
}
    
window.onload = async function() {
    // [1] IP 주소부터 가장 먼저 가져오기 (브라우저가 바빠지기 전 최우선 수행)
    const currentIP = await getIP();

    // [2] 그 다음 시크릿 모드 체크 (alert 창이 떠서 스크립트가 멈춰도 이미 IP는 확보된 상태)
    await checkIncognito(); 

    // [3] 중복 참여 체크
    if (localStorage.getItem('survey_finished') === 'true') {
        alert("이미 본 연구에 참여하셨습니다.");
        window.location.href = "about:blank";
        return;
    }

    // [4] ID 설정 및 초기 접속 기록
    let savedId = localStorage.getItem('survey_user_id');
    if (!savedId) {
        state.userId = 'ID_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('survey_user_id', state.userId);
        
        // 위에서 미리 받아둔 currentIP를 사용함
        recordInitialVisit(currentIP); 
    } else {
        state.userId = savedId;
    }

    // [5] 나머지 렌더링 로직 (기존 유지)
    preloadImages();
    renderDES();
    renderSEQ();
    renderCRF();
    document.querySelectorAll('.form-control').forEach(el => {
        if (el.value && el.value.trim() !== "") el.classList.add('selected');
        el.addEventListener('change', updateInputColor);
        el.addEventListener('input', updateInputColor);
    });
    showStep('step-consent');
};

   /* --- 비네트 대본 (수정 불가) --- */
   const vignettes = [
        { speaker: "", text: "당신은 최근 동성 애인과의 관계로 힘든 시기를 보냈습니다. 사소한 말다툼에도 이별과 재결합이 끊임없이 반복되었습니다. 당신은 수면 부족과 우울, 외로움에 시달리고 있습니다.", img: 'waiting' },
        { speaker: "", text: "잠을 제대로 못자고 아침에 지각하는 경우가 잦아지며 일상 생활에서도 어려움이 이어졌습니다.", img: 'waiting' },
        { speaker: "", text: "결국 전문가의 도움을 받기로 결심하고 집 근처 상담센터를 찾았습니다. 대기실 벽에 걸린 상담자의 이력과 자격증을 보니 마음이 놓입니다.", img: 'waiting' },
        { speaker: "", text: "당신은 직원의 안내에 따라 상담 경험과 방문 목적을 묻는 간단한 질문지를 작성했습니다.", img: 'waiting' },
        { speaker: "", text: "당신은 기대와 긴장이 뒤섞인 마음으로 상담을 기다립니다. 이제 직원의 안내에 따라 상담실 문을 열고 들어갑니다.", img: 'waiting' },
        { speaker: "상담자", text: "날이 추운데, 여기까지 오는 길은 괜찮으셨어요?", img: 'condition' },
        { speaker: "나", text: "네, 따뜻하게 입었더니 괜찮았어요.", img: 'condition' },
        { speaker: "상담자", text: "처음 오시는 곳이라 오기까지 고민도 되고 긴장도 되셨을 것 같아요. 상담은 오늘이 처음이시라고 하셨죠?", img: 'condition' },
        { speaker: "나", text: "네… 어떤 걸 말해야 할지 잘 모르겠어요.", img: 'condition' },
        { speaker: "상담자", text: "그럴 수 있어요. 처음 오시는 분들 거의 다 그렇게 이야기하세요. 편안한 만큼만, 떠오르는 것부터 천천히 말씀해 주셔도 괜찮아요.", img: 'condition' },
        { speaker: "상담자", text: "[사전에 작성한 질문지를 잠시 살핀다] 최근에 잠을 잘 못 주무신다고 적어 주셨네요.", img: 'condition' },
        { speaker: "나", text: "네.. 요즘 잠을 잘 못 자요. 밤에 자주 뒤척이다가 새벽에 겨우 잠들고, 몇 주째 아침마다 지각도 하고… 정신이 너무 없어요.", img: 'condition' },
        { speaker: "상담자", text: "몇 주째 잠도 제대로 못 자고, 아침마다 지각까지 하면서 하루를 버티고 계신 거네요. 몸도 마음도 많이 지치셨겠어요.", img: 'condition' },
        { speaker: "상담자", text: "잠을 못 잘 정도로, 계속 머릿속을 떠나지 않는 일이 있으신가요?", img: 'condition' },
        { speaker: "나", text: "…네, 그냥 전반적으로 요즘 많이 힘들어서요. 우울하고 외로워서… 어디 이야기할 데도 없고요. 음, 이런 이야기도 해도 되는지 모르겠는데...", img: 'condition' },
        { speaker: "상담자", text: "방금 말씀하신 우울함이랑 외로움, 그리고 ‘어디 말할 데가 없다’는 느낌이 특히 크게 느껴지네요. 그중에서 지금 가장 먼저 같이 들여다보고 싶은 건 어떤 부분인지, 편한 것부터 골라 주셔도 괜찮습니다.", img: 'condition' },
        { speaker: "나", text: "…가장 친한 사람과의 관계가 계속 꼬여서요. 예전에 크게 다투고 연락을 끊었는데, 최근에 연락이 와서 다시 받아줬거든요… 근데 또 반복되더라고요. 달라진 건 없고… 끊어내질 못하고 너무 지쳐요.", img: 'condition' },
        { speaker: "상담자", text: "가장 가까운 관계에서 그런 일이 반복되니까, 상처도 크고 에너지도 많이 소모되셨겠어요. 한편으로는 그 사람을 많이 소중하게 여기기 때문에 쉽게 끊어내지 못하는 마음도 같이 있으신 것 같고요.", img: 'condition' },
        { speaker: "상담자", text: "그 관계가 선생님께 어떤 의미였는지, 또 끊어내지 못하게 만드는 마음이 무엇인지가 앞으로 우리가 함께 살펴볼 중요한 부분이 될 것 같아요.", img: 'condition' },
        { speaker: "나", text: "...네.", img: 'condition' },
        { speaker: "상담자", text: "오늘은 첫 시간이라 힘드셨던 마음을 큰 흐름에서 같이 살펴봤어요. 오늘 용기 내서 와 주시고 이야기해 주셔서 고맙습니다.", img: 'condition' },
        { speaker: "상담자", text: "다음 시간에 오실 때는 그 관계에서 특히 힘들었던 순간과, 그럼에도 불구하고 놓기 어려운 이유를 한두 가지 정도만 떠올려 보실 수 있을까요?", img: 'condition' }
    ];

    /* --- 질문지 데이터 (수정 불가) --- */
    const desQuestions = ["1. 이 상담자에게 당신의 사적인 이야기를 하는 것은 위험할까요?", "2. 당신이 지금까지 아무에게도 말한 적이 없는 매우 사적인 일을 이 상담자에게 말한다면 불안하게 느껴질까요?", "3. 당신에게 슬프거나 괴로운 일이 생긴다면, 문제와 관련된 당신의 개인정보를 이 상담자에게 드러내는 것이 도움이 될까요?", "4. 당신의 숨겨둔 감정을 이 상담자에게 드러내는 것이 위험할까요?", "5. 당신이 이 상담자를 찾아가 속 이야기를 한다면 주변 사람들이 어떻게 생각할지 걱정되나요?", "6. 이 상담자에게 자신의 속마음을 말하는 것은 도움이 될까요?", "7. 만약 당신이 슬픔이나 불안 같은 감정을 드러낸다면 기분이 더 나아질까요?", "8. 만약 당신이 고민 중인 문제를 이 상담자에게 터놓는다면 실질적인 도움을 받을 것 같나요?"];
    const seqPairs = [{L:"힘들었다", R:"쉬웠다"}, {L:"가치있었다", R:"가치없었다"}, {L:"피상적이었다", R:"깊이있었다"}, {L:"마음 편했다", R:"긴장되었다"}, {L:"언짢았다", R:"즐거웠다"}, {L:"가득찼다", R:"비었다"}, {L:"약했다", R:"강했다"}, {L:"특별했다", R:"보통이었다"}, {L:"거칠었다", R:"매끄러웠다"}, {L:"편안했다", R:"불편했다"}];
    const crfQuestions = ["경험이 많다", "믿음직스럽다", "사교적이다", "노련하다", "우호적이다", "전문적이다", "진실하다", "온화하다", "정직하다", "호감이 간다", "준비가 되어있다", "신뢰할 수 있다."];
const guideMessages = {
    'des': {
        title: '자기개방 기대 척도',
        body: '다음 문항들은 앞서 보신 상담의 상담자에게 당신의 고민을 털어놓는 것에 대해 어떻게 예상하고 계신지를 묻는 질문입니다. 귀하께서는 어떻게 느끼셨는지, 그 정도를 나타내는 숫자에 표시해주십시오.'
    },
    'seq': {
        title: '상담회기평가',
        body: '다음 문항들은 귀하께서 이 상담자와 진행된 상담시간에 대해 어떻게 느끼고 있는지 알아보고자 하는 것입니다. 각 문항마다 대조되는 단어가 쌍으로 제시되어 있으며, 귀하께서는 앞서 본 상담시간에 대해 어떻게 느끼셨는지, 그 정도를 나타내는 숫자에 표시해주십시오.'
    },
    'crf': {
        title: '상담자 평가',
        body: '귀하께서 지금까지 상담자를 어떻게 보았는지, 그 정도를 가장 잘 나타내는 숫자에 표시하여 주십시오.'
    }
};
function preloadImages() { imgFiles.waiting && ['waiting.png', 'cross.png', 'buddha.png', 'none.png'].forEach(src => { const img = new Image(); img.src = src; }); }

    function renderDES() {
    document.getElementById('des-container').innerHTML = desQuestions.map((q, i) => `
        <div class="scale-group">
            <span class="scale-question" style="font-weight:bold; display:block; margin-bottom:10px;">${q}</span>
            <div class="scale-options">
                ${[1, 2, 3, 4, 5].map(v => `
                    <label class="scale-option">
                        <input type="radio" name="des_q${i}" value="${v}">
                        <span class="scale-number">${v}</span>
                    </label>`).join('')}
            </div>
            <div class="scale-labels">
                <span>전혀 그렇지 않다</span>
                <span>보통이다</span>
                <span>매우 그렇다</span>
            </div>
        </div>`).join('');
}

function renderSEQ() {
    document.getElementById('seq-container').innerHTML = seqPairs.map((p, i) => `
        <div class="scale-group">
            <div class="scale-labels" style="margin-bottom: 8px; font-weight:bold; color:#222;">
                <span style="text-align:left;">${p.L}</span>
                <span style="text-align:right;">${p.R}</span>
            </div>
            <div class="scale-options">
                ${[1, 2, 3, 4, 5, 6, 7].map(v => `
                    <label class="scale-option">
                        <input type="radio" name="seq_q${i}" value="${v}">
                        <span class="scale-number">${v}</span>
                    </label>`).join('')}
            </div>
            <div class="scale-labels">
                <span></span>
                <span> </span>
                <span></span>
            </div>
        </div>`).join('');
}

function renderCRF() {
    document.getElementById('crf-container').innerHTML = crfQuestions.map((q, i) => `
        <div class="scale-group">
            <span class="scale-question" style="font-weight:bold; display:block; margin-bottom:10px;">${q}</span>
            <div class="scale-options">
                ${[1, 2, 3, 4, 5, 6, 7].map(v => `
                    <label class="scale-option">
                        <input type="radio" name="crf_q${i}" value="${v}">
                        <span class="scale-number">${v}</span>
                    </label>`).join('')}
            </div>
            <div class="scale-labels">
                <span>전혀 그렇지 않다  </span>
                <span>보통이다</span>
                <span>매우 그렇다  </span>
            </div>
        </div>`).join('');
}
/* 1. 타이머 함수: 일반적인 슬라이드에서 버튼을 2초 후 활성화 */    
function startTimer() {
    const btn = document.getElementById('main-btn');
    if (!btn) return;

    btn.disabled = true; 
    btn.innerText = "읽는 중";

    setTimeout(() => {
        // 시크릿 모드가 아닐 때만 버튼을 다시 살림
        if (!state.isLocked) {
            btn.disabled = false;
            btn.innerText = "다음";
        } else {
            btn.innerText = "접속 제한됨";
        }
    }, 2000); 
}
    
/* 2. 비네트 렌더링 함수: 10초 대기와 배경색 처리를 통합 */
function renderVignette() {
    const idx = state.vignetteIndex;
    const current = vignettes[idx];
    const imgEl = document.getElementById('stimulus-img');
    const textBox = document.querySelector('.vn-text-box');
    const btn = document.getElementById('main-btn');

    const nextImgSrc = (current.img === 'waiting') ? imgFiles['waiting'] : imgFiles[state.condition];

    // [도우미] 배경색 및 텍스트 업데이트 함수
    const updateContent = () => {
        textBox.style.opacity = '1';
        document.getElementById('vignette-text').innerHTML = 
            `${current.speaker ? '<span class="speaker">'+current.speaker+'</span>' : ''}${current.text}`;
        
        // 배경색 적용
        textBox.classList.remove('speaker-counselor', 'speaker-me', 'speaker-default');
        if (current.speaker === "상담자") textBox.classList.add('speaker-counselor');
        else if (current.speaker === "나") textBox.classList.add('speaker-me');
        else textBox.classList.add('speaker-default');

        document.getElementById('page-counter').innerText = `${idx + 1} / ${vignettes.length}`;
    };

    if (idx === 5) {
        // --- [상담 시작: 10초 대기 모드] ---
        textBox.style.opacity = '0'; 
        btn.disabled = true;
        btn.innerText = "곧 상담이 시작됩니다";
        imgEl.src = nextImgSrc;

        setTimeout(() => {
            updateContent(); // 10초 후 내용 표시
            
            // [핵심] 10초 후 버튼 강제 활성화
            if (!state.isLocked) {
                btn.disabled = false;
                btn.innerText = "다음";
            }
        }, 10000); 

    } else {
        // --- [일반 슬라이드 모드] ---
        imgEl.src = nextImgSrc;
        updateContent(); // 즉시 내용 표시
        startTimer();    // 2초 타이머 실행
    }
}
    // 스피커 배경색 처리 (기존 유지)
    textBox.classList.remove('speaker-counselor', 'speaker-me', 'speaker-default');
    if (current.speaker === "상담자") textBox.classList.add('speaker-counselor');
    else if (current.speaker === "나") textBox.classList.add('speaker-me');
    else textBox.classList.add('speaker-default');
}

    function updateInputColor(event) {
    const el = event.target;
    // 값이 비어있지 않으면 'selected' 클래스 추가, 비어있으면 제거
    if (el.value && el.value.trim() !== "") {
        el.classList.add('selected');
    } else {
        el.classList.remove('selected');
    }
}
function handleNext() {
    const btn = document.getElementById('main-btn');
    
    // 1. 동의 단계
    if (state.step === 'consent') {
        const c = document.querySelector('input[name="consent_choice"]:checked');
        if (!c) return alert('동의 여부를 선택해 주세요.');
        if (c.value === 'disagree') return alert('동의하지 않으시면 참여하실 수 없습니다.');
        state.step = 'screener'; 
        showStep('step-screener');
        startImagePreload(); // 추가: 사용자가 인적사항을 적는 동안 이미지를 미리 다운로드함
        return;
    } 
    // 2. 인구통계 단계 (이 구간이 정확히 있어야 다음으로 넘어감)
    else if (state.step === 'screener') {
        if (!validateScreener()) return; 
        checkEligibility(); // 이 함수 내부에서 통과 시 state.step을 vignette로 바꿈
        return;
    } 
    // 3. 비네트(실험) 단계
    else if (state.step === 'vignette') {
        if (state.vignetteIndex < vignettes.length - 1) { 
            state.vignetteIndex++; 
            renderVignette(); 
        } else { 
            state.step = 'des-intro'; 
            showStep('step-des-intro'); 
            document.getElementById('des-intro-ref-img').src = imgFiles[state.condition]; 
            showModal('des'); 
        }
    } 
    // 4. DES 안내 -> 질문지
    else if (state.step === 'des-intro') { 
        state.step = 'des'; 
        showStep('step-des'); 
        document.getElementById('des-ref-img').src = imgFiles[state.condition]; 
    } 
    // 5. DES 질문지 -> SEQ 안내
    else if (state.step === 'des') { 
        if (!validateScale(8, 'des')) return; 
        state.step = 'seq-intro'; 
        showStep('step-seq-intro'); 
        document.getElementById('seq-intro-ref-img').src = imgFiles[state.condition]; 
        showModal('seq'); 
    } 
    // 6. SEQ 안내 -> 질문지
    else if (state.step === 'seq-intro') { 
        state.step = 'seq'; 
        showStep('step-seq'); 
        document.getElementById('seq-ref-img').src = imgFiles[state.condition]; 
    } 
    // 7. SEQ 질문지 -> CRF 안내
    else if (state.step === 'seq') { 
        if (!validateScale(10, 'seq')) return; 
        state.step = 'crf-intro'; 
        showStep('step-crf-intro'); 
        document.getElementById('crf-intro-ref-img').src = imgFiles[state.condition]; 
        showModal('crf');
    } 
    // 8. CRF 안내 -> 질문지
    else if (state.step === 'crf-intro') { 
        state.step = 'crf'; 
        showStep('step-crf'); 
        document.getElementById('crf-ref-img').src = imgFiles[state.condition]; 
    } 
    // 9. CRF 질문지 -> 조작 점검
else if (state.step === 'crf') { 
        if (!validateScale(12, 'crf')) return; 
        state.step = 'check'; showStep('step-check'); 
    } 
else if (state.step === 'check') { 
    if (!document.querySelector('input[name="check_opt"]:checked')) return alert('항목을 선택해 주세요.');
    
    // 종교 질문 단계로 이동
    state.step = 'religion-move'; 
    showStep('step-religion-move'); 
} 
else if (state.step === 'religion-move') {
    // 객관식 선택 여부 확인
    if (!document.getElementById('religion').value) return alert('종교를 선택해 주세요.');
    
    state.step = 'debrief'; 
    showStep('step-debrief'); 
    btn.innerText = "제출하기"; 
}
    else if (state.step === 'debrief') { 
        sendData(); 
    }
}

    
    function handlePrev() {
    if (state.step === 'screener') { 
        state.step = 'consent'; 
        showStep('step-consent'); 
    } else if (state.step === 'vignette') { 
        if (state.vignetteIndex > 0) { 
            state.vignetteIndex--; 
            renderVignette(); 
        } else { 
            state.step = 'screener'; 
            showStep('step-screener'); 
        } 
    } else if (state.step === 'des-intro') { 
        state.step = 'vignette'; 
        showStep('step-vignette'); 
        renderVignette(); 
    } else if (state.step === 'des') { 
        state.step = 'des-intro'; 
        showStep('step-des-intro'); 
    } else if (state.step === 'seq-intro') { 
        state.step = 'des'; 
        showStep('step-des'); 
    } else if (state.step === 'seq') { 
        state.step = 'seq-intro'; 
        showStep('step-seq-intro'); 
    } else if (state.step === 'crf-intro') { 
        state.step = 'seq'; 
        showStep('step-seq'); 
    } else if (state.step === 'crf') { 
        state.step = 'crf-intro'; 
        showStep('step-crf-intro'); 
    } else if (state.step === 'check') { 
        state.step = 'crf'; 
        showStep('step-crf'); 
    } else if (state.step === 'religion-move') { 
        state.step = 'check'; 
        showStep('step-check'); 
    } else if (state.step === 'debrief') { 
        state.step = 'religion-move'; 
        showStep('step-religion-move'); 
        document.getElementById('main-btn').innerText = "다음"; 
}
}
function validateScreener() {
    const ageInput = document.getElementById('age');
    const age = parseInt(ageInput.value);
    if (isNaN(age) || age < 10 || age > 100) { alert('나이를 정확히 입력해주세요.'); return false; }

    // 'religion'을 목록에서 제거함
    const ids = ['residence', 'orientation', 'birth_sex', 'current_gender']; 
    for(let id of ids) {
        const el = document.getElementById(id);
        if(!el.value.trim()) { alert('모든 질문에 답해 주세요.'); el.focus(); return false; }
    }
    return true;
}

    // 초기 방문 기록 함수 (누락된 부분 추가)
// [수정] IP를 매개변수로 받는 함수 정의
function recordInitialVisit(userIP) {
    if (localStorage.getItem('initial_visit_recorded')) return;
    const initialData = { 
        method: 'initial', 
        id: state.userId, 
        ip: userIP, // 받아온 IP를 여기에 넣습니다.
        condition: state.condition 
    };
    fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(initialData) })
    .then(() => localStorage.setItem('initial_visit_recorded', 'true'));
}
    
// 자격 확인 함수 (중복 제거 및 통합)
async function checkEligibility() {
    const ageValue = document.getElementById('age').value;
    const age = parseInt(ageValue);
    const orient = document.getElementById('orientation').value;
    const bSex = document.getElementById('birth_sex').value;
    const cGen = document.getElementById('current_gender').value;
    const res = document.getElementById('residence').value;

    // 1. 자격 확인
    if (age >= 19 && orient !== 'hetero' && orient !== 'dontknow' && bSex === cGen) {
        
        // 2. [핵심] IP 주소 먼저 가져오기
        const userIP = await getIP(); 

        // 3. 데이터를 객체로 구성 (ip 추가)
        const demographicData = {
            id: state.userId,
            ip: userIP, // 이 줄이 있어야 unknown이 안 뜹니다.
            condition: state.condition,
            age: ageValue,
            residence: res,
            orientation: orient,
            birth_sex: bSex,
            current_gender: cGen
        };

        // 4. 구글 시트로 전송
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(demographicData)
        });

        // 5. 다음 단계로 이동
        state.step = 'vignette'; 
        showStep('step-vignette'); 
        renderVignette();
    } else {
        alert("본 연구의 참여 대상자에 해당하지 않아 설문을 종료합니다."); 
        window.location.href = "about:blank";
    }
}
    function validateScale(count, prefix) {
        for(let i=0; i<count; i++) { if(!document.querySelector(`input[name="${prefix}_q${i}"]:checked`)) { alert(`${i+1}번 문항에 응답해 주세요.`); return false; } }
        return true;
    }


// showStep 함수 수정 (이전 버튼 노출 조건 완화)
function showStep(id) {
    document.querySelectorAll('.content > div').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    
    const area = document.getElementById('content-area');
    area.classList.toggle('full-screen-mode', id === 'step-vignette');
    area.scrollTop = 0;

    // 첫 페이지(consent)가 아니면 이전 버튼을 보여줌
    const prevBtn = document.getElementById('prev-btn');
    if (state.step === 'consent') {
        prevBtn.style.visibility = 'hidden';
    } else {
        prevBtn.style.visibility = 'visible';
    }
}

    function showModal(type) {
        const modal = document.getElementById('guide-modal');
        document.getElementById('modal-title').innerText = guideMessages[type].title;
        document.getElementById('modal-body').innerText = guideMessages[type].body;
        modal.style.display = 'flex';
    }

    function closeModal() { document.getElementById('guide-modal').style.display = 'none'; }
    

    function handleExit() { if(confirm("실험을 중단하시겠습니까?")) window.close(); }

    /* 2. 기존 sendData 함수를 이것으로 교체 */
async function sendData() { // async 키워드 확인!
    const btn = document.getElementById('main-btn');
    btn.disabled = true; 
    btn.innerText = "제출 중";
    
    // IP 주소 가져오기 대기
    const userIP = await getIP();

    const checkOptEl = document.querySelector('input[name="check_opt"]:checked');
    let checkAns = checkOptEl ? checkOptEl.value : "미응답";
    if (checkAns === 'etc') checkAns = "기타: " + document.getElementById('check-etc-input').value;

    const results = {
        id: state.userId,
        ip: userIP, // 여기에 IP 주소 포함
        condition: state.condition,
        age: document.getElementById('age').value,
        residence: document.getElementById('residence').value,
        orientation: document.getElementById('orientation').value,
        birth_sex: document.getElementById('birth_sex').value,
        current_gender: document.getElementById('current_gender').value,
        religion: document.getElementById('religion').value,
        check_answer: checkAns,
        phone: document.getElementById('reward-phone').value || "",
        des_scores: Array.from({length:8}, (_,i) => document.querySelector(`input[name="des_q${i}"]:checked`).value).join(','),
        seq_scores: Array.from({length:10}, (_,i) => document.querySelector(`input[name="seq_q${i}"]:checked`).value).join(','),
        crf_scores: Array.from({length:12}, (_,i) => document.querySelector(`input[name="crf_q${i}"]:checked`).value).join(',')
    };

    fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(results)
    })
    .then(() => {
        localStorage.setItem('survey_finished', 'true');
        showStep('step-complete');
        document.querySelector('.bottom-bar').style.display = 'none';
    })
    .catch((err) => {
        alert("오류 발생. 다시 시도해주세요.");
        btn.disabled = false;
        btn.innerText = "제출하기";
    });
}
</script>
